<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>SteelSketch Pro - Ã‰diteur</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #1e40af;
      --primary-hover: #1d4ed8;
      --secondary: #64748b;
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --text: #0f172a;
      --text-secondary: #64748b;
      --border: #e2e8f0;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
      --success: #22c55e;
      --warning: #facc15;
      --danger: #ef4444;
      --info: #3b82f6;
      --toolbar-h: 70px;
      --sidebar-w: 80px;
      --panel-w: 300px;
      --grid-color: #e2e8f0;
      --canvas-bg: #ffffff;
    }

    body.dark {
      --bg: #0f172a;
      --card-bg: #1e293b;
      --text: #f8fafc;
      --text-secondary: #94a3b8;
      --border: #475569;
      --primary: #60a5fa;
      --primary-hover: #3b82f6;
      --grid-color: #374151;
      --canvas-bg: #1e293b;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: all 0.3s ease;
      overflow: hidden;
      height: 100vh;
    }

    header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: var(--toolbar-h);
      background: linear-gradient(270deg, var(--primary), #0ea5e9, var(--primary));
      background-size: 400% 400%;
      animation: headerGradient 10s ease infinite;
      color: white;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow-md);
      z-index: 1000;
    }

    @keyframes headerGradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .logo {
      font-size: 24px;
      font-weight: 700;
      letter-spacing: -0.5px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-center {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
    }

    .project-info {
      background: rgba(255,255,255,0.1);
      padding: 8px 16px;
      border-radius: 20px;
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .project-name {
      font-size: 16px;
      font-weight: 600;
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    .header-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
      padding: 8px 15px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 5px;
      backdrop-filter: blur(10px);
    }

    .header-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-1px);
    }

    .header-btn.save { background: var(--success); border-color: rgba(255,255,255,0.5); }
    .header-btn.export { background: var(--warning); border-color: rgba(255,255,255,0.5); }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .theme-toggle {
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      padding: 10px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .theme-toggle:hover {
      background: rgba(255,255,255,0.3);
      transform: scale(1.1);
    }

    .sidebar-nav {
      position: fixed;
      left: 0;
      top: var(--toolbar-h);
      width: var(--sidebar-w);
      height: calc(100vh - var(--toolbar-h));
      background: var(--card-bg);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      z-index: 900;
      box-shadow: var(--shadow-sm);
    }

    .nav-tabs {
      display: flex;
      flex-direction: column;
      padding: 10px 0;
    }

    .nav-tab {
      width: 100%;
      height: 60px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: all 0.3s ease;
      position: relative;
    }

    .nav-tab:hover {
      background: var(--bg);
      color: var(--text);
    }

    .nav-tab.active {
      background: var(--primary);
      color: white;
    }

    .nav-tab.active::after {
      content: '';
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 3px;
      height: 30px;
      background: white;
      border-radius: 2px 0 0 2px;
    }

    .nav-tab i {
      font-size: 20px;
    }

    .nav-tab span {
      font-size: 10px;
      font-weight: 500;
    }

    .side-panel {
      position: fixed;
      left: var(--sidebar-w);
      top: var(--toolbar-h);
      width: var(--panel-w);
      height: calc(100vh - var(--toolbar-h) - 32px);
      background: var(--card-bg);
      border-right: 1px solid var(--border);
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      z-index: 800;
      box-shadow: var(--shadow-md);
      overflow-y: auto;
    }

    .side-panel.show {
      transform: translateX(0);
    }

    .panel-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .panel-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .panel-content {
      padding: 20px;
    }

    .section {
      margin-bottom: 25px;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .tool-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-bottom: 20px;
    }

    .tool-item {
      aspect-ratio: 1;
      border: 2px solid var(--border);
      border-radius: 8px;
      background: var(--card-bg);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: all 0.3s ease;
    }

    .tool-item:hover {
      border-color: var(--primary);
      background: rgba(30, 64, 175, 0.05);
      transform: translateY(-2px);
    }

    .tool-item.active {
      border-color: var(--primary);
      background: var(--primary);
      color: white;
    }

    .tool-item i {
      font-size: 20px;
    }

    .tool-item span {
      font-size: 10px;
      font-weight: 500;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 6px;
    }

    .form-input, .form-select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--card-bg);
      color: var(--text);
      font-size: 14px;
      transition: border-color 0.3s ease;
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .btn {
      padding: 10px 16px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--card-bg);
      color: var(--text);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
    }

    .btn:hover {
      background: var(--bg);
      transform: translateY(-1px);
    }

    .btn.primary {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .btn.primary:hover {
      background: var(--primary-hover);
    }

    .workspace {
      position: fixed;
      left: var(--sidebar-w);
      top: var(--toolbar-h);
      right: 0;
      bottom: 32px;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: left 0.3s ease;
    }

    .workspace.panel-open {
      left: calc(var(--sidebar-w) + var(--panel-w));
    }

    .canvas-container {
      position: relative;
      background: transparent;
      padding: 40px;
      border-radius: 12px;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #mainCanvas {
      background: var(--canvas-bg);
      border: 2px solid var(--border);
      border-radius: 8px;
      cursor: crosshair;
      box-shadow: var(--shadow-md);
      transition: all 0.3s ease;
    }

    .zoom-controls {
      position: absolute;
      bottom: 20px;
      right: 20px;
      display: flex;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }

    .zoom-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: var(--card-bg);
      color: var(--text);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .zoom-btn:hover {
      background: var(--bg);
    }

    .zoom-display {
      padding: 0 15px;
      display: flex;
      align-items: center;
      font-size: 14px;
      font-weight: 500;
      background: var(--bg);
      border-left: 1px solid var(--border);
      border-right: 1px solid var(--border);
    }

    .status-bar {
      position: fixed;
      bottom: 0;
      left: var(--sidebar-w);
      right: 0;
      height: 32px;
      background: var(--card-bg);
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 20px;
      font-size: 12px;
      color: var(--text-secondary);
      z-index: 100;
      transition: left 0.3s ease;
    }

    .status-bar.panel-open {
      left: calc(var(--sidebar-w) + var(--panel-w));
    }

    .status-item {
      margin-right: 20px;
    }

    .status-right {
      margin-left: auto;
      display: flex;
      gap: 20px;
    }

    .shape-item {
      display: flex;
      align-items: center;
      padding: 12px;
      background: var(--bg);
      border-radius: 8px;
      margin-bottom: 8px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .shape-item:hover {
      transform: translateX(5px);
      box-shadow: var(--shadow-sm);
    }

    .shape-item.selected {
      background: rgba(30, 64, 175, 0.1);
      border: 2px solid var(--primary);
    }

    .shape-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      color: white;
    }

    .shape-info {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }

    .shape-details {
      flex: 1;
    }

    .shape-name {
      font-weight: 500;
      font-size: 14px;
      margin-bottom: 2px;
    }

    .shape-dimensions {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .shape-actions {
      display: flex;
      gap: 4px;
    }

    .shape-action {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 6px;
      border-radius: 4px;
      transition: all 0.3s ease;
    }

    .shape-action:hover {
      background: var(--bg);
      color: var(--primary);
    }

    .notification {
      position: fixed;
      top: 90px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: var(--shadow-md);
      z-index: 3000;
      animation: slideInRight 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 500;
      min-width: 280px;
    }

    .notification.success { background: var(--success); color: white; }
    .notification.error { background: var(--danger); color: white; }
    .notification.info { background: var(--info); color: white; }
    .notification.warning { background: var(--warning); color: white; }

    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <i class="fas fa-cube"></i>
      SteelSketch Pro
    </div>
    <div class="header-center">
      <div class="project-info">
        <div class="project-name" id="project-name">Nouveau Projet</div>
      </div>
      <div class="header-actions">
        <button class="header-btn" onclick="undo()" title="Annuler (Ctrl+Z)">
          <i class="fas fa-undo"></i>
        </button>
        <button class="header-btn" onclick="redo()" title="Refaire (Ctrl+Y)">
          <i class="fas fa-redo"></i>
        </button>
        <button class="header-btn save" onclick="saveProject()" title="Sauvegarder (Ctrl+S)">
          <i class="fas fa-save"></i> Sauvegarder
        </button>
        <button class="header-btn export" onclick="exportProject()" title="Exporter">
          <i class="fas fa-download"></i> Exporter
        </button>
      </div>
    </div>
    <div class="user-info">
      <button class="theme-toggle" onclick="toggleTheme()" title="Changer de thÃ¨me">
        <i class="fas fa-moon" id="theme-icon"></i>
      </button>
      <span id="user-name">Utilisateur</span>
    </div>
  </header>

  <nav class="sidebar-nav">
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="showPanel('tools')">
        <i class="fas fa-tools"></i>
        <span>Outils</span>
      </button>
      <button class="nav-tab" onclick="showPanel('shapes')">
        <i class="fas fa-shapes"></i>
        <span>Formes</span>
      </button>
      <button class="nav-tab" onclick="showPanel('settings')">
        <i class="fas fa-cog"></i>
        <span>Config</span>
      </button>
    </div>
  </nav>

  <div class="side-panel show" id="tools-panel">
    <div class="panel-header">
      <h3 class="panel-title">
        <i class="fas fa-tools"></i>
        Outils de dessin
      </h3>
    </div>
    <div class="panel-content">
      <div class="section">
        <div class="section-title">Outils de base</div>
        <div class="tool-grid">
          <div class="tool-item active" data-tool="select" onclick="selectTool('select')">
            <i class="fas fa-mouse-pointer"></i>
            <span>SÃ©lection</span>
          </div>
          <div class="tool-item" data-tool="rectangle" onclick="selectTool('rectangle')">
            <i class="fas fa-square"></i>
            <span>Rectangle</span>
          </div>
          <div class="tool-item" data-tool="circle" onclick="selectTool('circle')">
            <i class="fas fa-circle"></i>
            <span>Cercle</span>
          </div>
          <div class="tool-item" data-tool="line" onclick="selectTool('line')">
            <i class="fas fa-minus"></i>
            <span>Ligne</span>
          </div>
          <div class="tool-item" data-tool="drill" onclick="selectTool('drill')">
            <i class="fas fa-circle-dot"></i>
            <span>PerÃ§age</span>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">ParamÃ¨tres</div>
        <div class="form-group">
          <label class="form-label">Ã‰paisseur trait (mm)</label>
          <input type="number" class="form-input" id="line-thickness" value="2" step="0.1" min="0.1">
        </div>
        <div class="form-group">
          <label class="form-label">Couleur</label>
          <input type="color" class="form-input" id="tool-color" value="#1e40af">
        </div>
      </div>
    </div>
  </div>

  <div class="side-panel" id="shapes-panel">
    <div class="panel-header">
      <h3 class="panel-title">
        <i class="fas fa-shapes"></i>
        Formes
      </h3>
    </div>
    <div class="panel-content">
      <div class="section">
        <div class="section-title">Formes sur la tÃ´le</div>
        <div id="shapes-list">
          <div style="text-align: center; color: var(--text-secondary); padding: 40px 20px;">
            <i class="fas fa-shapes" style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;"></i>
            <p>Aucune forme</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="side-panel" id="settings-panel">
    <div class="panel-header">
      <h3 class="panel-title">
        <i class="fas fa-cog"></i>
        Configuration
      </h3>
    </div>
    <div class="panel-content">
      <div class="section">
        <div class="section-title">Dimensions de la tÃ´le</div>
        <div class="form-group">
          <label class="form-label">Largeur (mm)</label>
          <input type="number" class="form-input" id="sheet-width" value="1000" min="100" step="10">
        </div>
        <div class="form-group">
          <label class="form-label">Hauteur (mm)</label>
          <input type="number" class="form-input" id="sheet-height" value="600" min="100" step="10">
        </div>
        <div class="form-group">
          <label class="form-label">Ã‰paisseur (mm)</label>
          <input type="number" class="form-input" id="sheet-thickness" value="2" step="0.1" min="0.1">
        </div>
        <button class="btn primary" onclick="applySettings()">
          <i class="fas fa-check"></i>
          Appliquer
        </button>
      </div>
    </div>
  </div>

  <main class="workspace" id="workspace">
    <div class="canvas-container">
      <canvas id="mainCanvas"></canvas>
    </div>
    
    <div class="zoom-controls">
      <button class="zoom-btn" onclick="zoomOut()" title="Zoom arriÃ¨re">
        <i class="fas fa-search-minus"></i>
      </button>
      <div class="zoom-display" id="zoom-display">100%</div>
      <button class="zoom-btn" onclick="zoomIn()" title="Zoom avant">
        <i class="fas fa-search-plus"></i>
      </button>
      <button class="zoom-btn" onclick="resetZoom()" title="RÃ©initialiser">
        <i class="fas fa-expand-arrows-alt"></i>
      </button>
    </div>
  </main>

  <div class="status-bar" id="status-bar">
    <div class="status-item">PrÃªt</div>
    <div class="status-item">Formes: <span id="shapes-count">0</span></div>
    <div class="status-right">
      <div class="status-item">Curseur: <span id="cursor-pos">0, 0</span></div>
      <div class="status-item">Zoom: <span id="status-zoom">100%</span></div>
    </div>
  </div>

  <script>
    let canvas, ctx;
    let currentTool = 'select';
    let shapes = [];
    let selectedShape = null;
    let isDrawing = false;
    let startX, startY;
    let zoom = 1;
    let panX = 0, panY = 0;
    let history = [];
    let historyStep = -1;
    
    const pixelsPerMM = 2;
    let sheetConfig = {
      width: 1000,
      height: 600,
      thickness: 2
    };

    function init() {
      canvas = document.getElementById('mainCanvas');
      ctx = canvas.getContext('2d');
      
      resizeCanvas();
      
      canvas.addEventListener('mousedown', handleMouseDown);
      canvas.addEventListener('mousemove', handleMouseMove);
      canvas.addEventListener('mouseup', handleMouseUp);
      canvas.addEventListener('wheel', handleWheel, { passive: false });
      
      window.addEventListener('resize', resizeCanvas);
      document.addEventListener('keydown', handleKeyboard);
      
      redraw();
    }

    function resizeCanvas() {
      const container = document.querySelector('.canvas-container');
      const rect = container.getBoundingClientRect();
      
      canvas.width = Math.min(sheetConfig.width * pixelsPerMM + 200, rect.width - 80);
      canvas.height = Math.min(sheetConfig.height * pixelsPerMM + 200, rect.height - 80);
      
      redraw();
    }

    function redraw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      ctx.save();
      ctx.scale(zoom, zoom);
      ctx.translate(panX, panY);
      
      drawSheet();
      shapes.forEach(shape => drawShape(shape));
      
      if (selectedShape) {
        drawSelection(selectedShape);
      }
      
      ctx.restore();
      
      updateZoomDisplay();
    }

    function drawSheet() {
      const sheetX = (canvas.width/zoom - sheetConfig.width * pixelsPerMM) / 2;
      const sheetY = (canvas.height/zoom - sheetConfig.height * pixelsPerMM) / 2;
      const sheetW = sheetConfig.width * pixelsPerMM;
      const sheetH = sheetConfig.height * pixelsPerMM;
      
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--canvas-bg');
      ctx.fillRect(sheetX, sheetY, sheetW, sheetH);
      
      ctx.strokeStyle = '#1e40af';
      ctx.lineWidth = 3;
      ctx.strokeRect(sheetX, sheetY, sheetW, sheetH);
    }

    function drawShape(shape) {
      const sheetX = (canvas.width/zoom - sheetConfig.width * pixelsPerMM) / 2;
      const sheetY = (canvas.height/zoom - sheetConfig.height * pixelsPerMM) / 2;
      
      ctx.strokeStyle = shape.color || '#1e40af';
      ctx.fillStyle = shape.color || '#1e40af';
      ctx.lineWidth = shape.lineWidth || 2;
      
      const x = sheetX + shape.x * pixelsPerMM;
      const y = sheetY + shape.y * pixelsPerMM;
      
      switch(shape.type) {
        case 'rectangle':
          ctx.strokeRect(x, y, shape.width * pixelsPerMM, shape.height * pixelsPerMM);
          break;
        case 'circle':
          ctx.beginPath();
          ctx.arc(x, y, shape.radius * pixelsPerMM, 0, Math.PI * 2);
          ctx.stroke();
          break;
        case 'line':
          ctx.beginPath();
          ctx.moveTo(x, y);
          ctx.lineTo(sheetX + shape.x2 * pixelsPerMM, sheetY + shape.y2 * pixelsPerMM);
          ctx.stroke();
          break;
        case 'drill':
          ctx.beginPath();
          ctx.arc(x, y, shape.radius * pixelsPerMM, 0, Math.PI * 2);
          ctx.fillStyle = '#ef4444';
          ctx.fill();
          ctx.stroke();
          break;
      }
    }

    function drawSelection(shape) {
      const sheetX = (canvas.width/zoom - sheetConfig.width * pixelsPerMM) / 2;
      const sheetY = (canvas.height/zoom - sheetConfig.height * pixelsPerMM) / 2;
      
      ctx.strokeStyle = '#22c55e';
      ctx.lineWidth = 2;
      ctx.setLineDash([5, 5]);
      
      let bounds = getShapeBounds(shape);
      const x = sheetX + bounds.x * pixelsPerMM - 5;
      const y = sheetY + bounds.y * pixelsPerMM - 5;
      const w = bounds.width * pixelsPerMM + 10;
      const h = bounds.height * pixelsPerMM + 10;
      
      ctx.strokeRect(x, y, w, h);
      ctx.setLineDash([]);
    }

    function getShapeBounds(shape) {
      switch(shape.type) {
        case 'rectangle':
          return { x: shape.x, y: shape.y, width: shape.width, height: shape.height };
        case 'circle':
        case 'drill':
          return { 
            x: shape.x - shape.radius, 
            y: shape.y - shape.radius, 
            width: shape.radius * 2, 
            height: shape.radius * 2 
          };
        case 'line':
          return {
            x: Math.min(shape.x, shape.x2),
            y: Math.min(shape.y, shape.y2),
            width: Math.abs(shape.x2 - shape.x),
            height: Math.abs(shape.y2 - shape.y)
          };
        default:
          return { x: 0, y: 0, width: 0, height: 0 };
      }
    }

    function handleMouseDown(e) {
      const rect = canvas.getBoundingClientRect();
      const mouseX = (e.clientX - rect.left) / zoom - panX;
      const mouseY = (e.clientY - rect.top) / zoom - panY;
      
      const sheetX = (canvas.width/zoom - sheetConfig.width * pixelsPerMM) / 2;
      const sheetY = (canvas.height/zoom - sheetConfig.height * pixelsPerMM) / 2;
      
      startX = (mouseX - sheetX) / pixelsPerMM;
      startY = (mouseY - sheetY) / pixelsPerMM;
      
      if (currentTool === 'select') {
        selectedShape = findShapeAtPoint(startX, startY);
        redraw();
        updateShapesList();
      } else {
        isDrawing = true;
      }
    }

    function handleMouseMove(e) {
      const rect = canvas.getBoundingClientRect();
      const mouseX = (e.clientX - rect.left) / zoom - panX;
      const mouseY = (e.clientY - rect.top) / zoom - panY;
      
      const sheetX = (canvas.width/zoom - sheetConfig.width * pixelsPerMM) / 2;
      const sheetY = (canvas.height/zoom - sheetConfig.height * pixelsPerMM) / 2;
      
      const currentX = (mouseX - sheetX) / pixelsPerMM;
      const currentY = (mouseY - sheetY) / pixelsPerMM;
      
      document.getElementById('cursor-pos').textContent = `${Math.round(currentX)}, ${Math.round(currentY)}`;
      
      if (isDrawing && currentTool !== 'select') {
        redraw();
        drawPreview(startX, startY, currentX, currentY);
      }
    }

    function handleMouseUp(e) {
      if (!isDrawing) return;
      
      const rect = canvas.getBoundingClientRect();
      const mouseX = (e.clientX - rect.left) / zoom - panX;
      const mouseY = (e.clientY - rect.top) / zoom - panY;
      
      const sheetX = (canvas.width/zoom - sheetConfig.width * pixelsPerMM) / 2;
      const sheetY = (canvas.height/zoom - sheetConfig.height * pixelsPerMM) / 2;
      
      const endX = (mouseX - sheetX) / pixelsPerMM;
      const endY = (mouseY - sheetY) / pixelsPerMM;
      
      createShape(startX, startY, endX, endY);
      
      isDrawing = false;
      redraw();
    }

    function drawPreview(x1, y1, x2, y2) {
      const sheetX = (canvas.width/zoom - sheetConfig.width * pixelsPerMM) / 2;
      const sheetY = (canvas.height/zoom - sheetConfig.height * pixelsPerMM) / 2;
      
      ctx.save();
      ctx.scale(zoom, zoom);
      ctx.translate(panX, panY);
      
      ctx.strokeStyle = '#94a3b8';
      ctx.lineWidth = 1;
      ctx.setLineDash([3, 3]);
      
      const startXPx = sheetX + x1 * pixelsPerMM;
      const startYPx = sheetY + y1 * pixelsPerMM;
      const endXPx = sheetX + x2 * pixelsPerMM;
      const endYPx = sheetY + y2 * pixelsPerMM;
      
      switch (currentTool) {
        case 'rectangle':
          ctx.strokeRect(startXPx, startYPx, endXPx - startXPx, endYPx - startYPx);
          break;
        case 'circle':
          const radius = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
          ctx.beginPath();
          ctx.arc(startXPx, startYPx, radius * pixelsPerMM, 0, Math.PI * 2);
          ctx.stroke();
          break;
        case 'line':
          ctx.beginPath();
          ctx.moveTo(startXPx, startYPx);
          ctx.lineTo(endXPx, endYPx);
          ctx.stroke();
          break;
      }
      
      ctx.restore();
    }

    function createShape(x1, y1, x2, y2) {
      let newShape = null;
      const color = document.getElementById('tool-color').value;
      const lineWidth = parseFloat(document.getElementById('line-thickness').value);
      
      switch (currentTool) {
        case 'rectangle':
          if (Math.abs(x2 - x1) < 5 || Math.abs(y2 - y1) < 5) return;
          newShape = {
            id: generateId(),
            type: 'rectangle',
            x: Math.min(x1, x2),
            y: Math.min(y1, y2),
            width: Math.abs(x2 - x1),
            height: Math.abs(y2 - y1),
            color: color,
            lineWidth: lineWidth
          };
          break;
          
        case 'circle':
          const radius = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
          if (radius < 5) return;
          newShape = {
            id: generateId(),
            type: 'circle',
            x: x1,
            y: y1,
            radius: radius,
            color: color,
            lineWidth: lineWidth
          };
          break;
          
        case 'line':
          if (Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2)) < 10) return;
          newShape = {
            id: generateId(),
            type: 'line',
            x: x1,
            y: y1,
            x2: x2,
            y2: y2,
            color: color,
            lineWidth: lineWidth
          };
          break;
          
        case 'drill':
          newShape = {
            id: generateId(),
            type: 'drill',
            x: x1,
            y: y1,
            radius: 2.5,
            color: '#ef4444',
            lineWidth: 1
          };
          break;
      }
      
      if (newShape) {
        shapes.push(newShape);
        selectedShape = newShape;
        saveToHistory();
        updateShapesList();
        showNotification(`${getShapeName(newShape.type)} crÃ©Ã©`, 'success');
      }
    }

    function findShapeAtPoint(x, y) {
      for (let i = shapes.length - 1; i >= 0; i--) {
        if (isPointInShape(x, y, shapes[i])) {
          return shapes[i];
        }
      }
      return null;
    }

    function isPointInShape(x, y, shape) {
      const tolerance = 5;
      
      switch (shape.type) {
        case 'rectangle':
          return x >= shape.x - tolerance && x <= shape.x + shape.width + tolerance && 
                 y >= shape.y - tolerance && y <= shape.y + shape.height + tolerance;
        case 'circle':
          const dx = x - shape.x;
          const dy = y - shape.y;
          return Math.sqrt(dx * dx + dy * dy) <= shape.radius + tolerance;
        case 'line':
          return distanceToLine(x, y, shape.x, shape.y, shape.x2, shape.y2) <= tolerance;
        case 'drill':
          const drillDx = x - shape.x;
          const drillDy = y - shape.y;
          return Math.sqrt(drillDx * drillDx + drillDy * drillDy) <= shape.radius + tolerance;
        default:
          return false;
      }
    }

    function distanceToLine(px, py, x1, y1, x2, y2) {
      const A = px - x1;
      const B = py - y1;
      const C = x2 - x1;
      const D = y2 - y1;
      
      const dot = A * C + B * D;
      const lenSq = C * C + D * D;
      
      if (lenSq === 0) return Math.sqrt(A * A + B * B);
      
      const param = Math.max(0, Math.min(1, dot / lenSq));
      const xx = x1 + param * C;
      const yy = y1 + param * D;
      
      const dx = px - xx;
      const dy = py - yy;
      return Math.sqrt(dx * dx + dy * dy);
    }

    function handleWheel(e) {
      e.preventDefault();
      const delta = e.deltaY > 0 ? 0.9 : 1.1;
      zoom = Math.max(0.1, Math.min(5, zoom * delta));
      redraw();
    }

    function handleKeyboard(e) {
      if (e.target.tagName === 'INPUT') return;
      
      if (e.ctrlKey || e.metaKey) {
        switch(e.key.toLowerCase()) {
          case 's': e.preventDefault(); saveProject(); break;
          case 'z': e.preventDefault(); undo(); break;
          case 'y': e.preventDefault(); redo(); break;
        }
      } else {
        switch(e.key.toLowerCase()) {
          case 's': selectTool('select'); break;
          case 'r': selectTool('rectangle'); break;
          case 'c': selectTool('circle'); break;
          case 'l': selectTool('line'); break;
          case 'd': selectTool('drill'); break;
          case 'delete':
          case 'backspace':
            if (selectedShape) {
              deleteShape(selectedShape.id);
              e.preventDefault();
            }
            break;
        }
      }
    }

    function selectTool(tool) {
      currentTool = tool;
      
      document.querySelectorAll('.tool-item').forEach(item => {
        item.classList.remove('active');
      });
      
      const toolItem = document.querySelector(`[data-tool="${tool}"]`);
      if (toolItem) toolItem.classList.add('active');
      
      canvas.style.cursor = tool === 'select' ? 'default' : 'crosshair';
    }

    function showPanel(panelName) {
      document.querySelectorAll('.side-panel').forEach(panel => {
        panel.classList.remove('show');
      });
      
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      const panel = document.getElementById(panelName + '-panel');
      if (panel) {
        panel.classList.add('show');
        document.getElementById('workspace').classList.add('panel-open');
        document.getElementById('status-bar').classList.add('panel-open');
      }
      
      event.target.closest('.nav-tab').classList.add('active');
      
      setTimeout(resizeCanvas, 300);
    }

    function updateShapesList() {
      const container = document.getElementById('shapes-list');
      document.getElementById('shapes-count').textContent = shapes.length;
      
      if (shapes.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; color: var(--text-secondary); padding: 40px 20px;">
            <i class="fas fa-shapes" style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;"></i>
            <p>Aucune forme</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = shapes.map((shape, index) => `
        <div class="shape-item ${selectedShape && selectedShape.id === shape.id ? 'selected' : ''}" onclick="selectShape('${shape.id}')">
          <div class="shape-info">
            <div class="shape-icon" style="background: ${shape.color}">
              <i class="fas ${getShapeIcon(shape.type)}"></i>
            </div>
            <div class="shape-details">
              <div class="shape-name">${getShapeName(shape.type)} ${index + 1}</div>
              <div class="shape-dimensions">${getShapeDimensions(shape)}</div>
            </div>
          </div>
          <div class="shape-actions">
            <button class="shape-action" onclick="event.stopPropagation(); duplicateShape('${shape.id}')" title="Dupliquer">
              <i class="fas fa-copy"></i>
            </button>
            <button class="shape-action" onclick="event.stopPropagation(); deleteShape('${shape.id}')" title="Supprimer">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      `).join('');
    }

    function getShapeIcon(type) {
      const icons = {
        'rectangle': 'fa-square',
        'circle': 'fa-circle',
        'line': 'fa-minus',
        'drill': 'fa-circle-dot'
      };
      return icons[type] || 'fa-square';
    }

    function getShapeName(type) {
      const names = {
        'rectangle': 'Rectangle',
        'circle': 'Cercle',
        'line': 'Ligne',
        'drill': 'PerÃ§age'
      };
      return names[type] || type;
    }

    function getShapeDimensions(shape) {
      switch (shape.type) {
        case 'rectangle':
          return `${Math.round(shape.width)} Ã— ${Math.round(shape.height)} mm`;
        case 'circle':
          return `âŒ€ ${Math.round(shape.radius * 2)} mm`;
        case 'line':
          const length = Math.sqrt(Math.pow(shape.x2 - shape.x, 2) + Math.pow(shape.y2 - shape.y, 2));
          return `${Math.round(length)} mm`;
        case 'drill':
          return `âŒ€ ${Math.round(shape.radius * 2)} mm`;
        default:
          return '';
      }
    }

    function selectShape(id) {
      selectedShape = shapes.find(s => s.id === id);
      redraw();
      updateShapesList();
    }

    function duplicateShape(id) {
      const shape = shapes.find(s => s.id === id);
      if (!shape) return;
      
      const duplicate = { ...shape, id: generateId(), x: shape.x + 20, y: shape.y + 20 };
      if (shape.x2 !== undefined) duplicate.x2 = shape.x2 + 20;
      if (shape.y2 !== undefined) duplicate.y2 = shape.y2 + 20;
      
      shapes.push(duplicate);
      selectedShape = duplicate;
      saveToHistory();
      updateShapesList();
      redraw();
      showNotification('Forme dupliquÃ©e', 'success');
    }

    function deleteShape(id) {
      const index = shapes.findIndex(s => s.id === id);
      if (index === -1) return;
      
      shapes.splice(index, 1);
      if (selectedShape && selectedShape.id === id) {
        selectedShape = null;
      }
      saveToHistory();
      updateShapesList();
      redraw();
      showNotification('Forme supprimÃ©e', 'success');
    }

    function generateId() {
      return 'shape_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function saveToHistory() {
      if (historyStep < history.length - 1) {
        history = history.slice(0, historyStep + 1);
      }
      history.push(JSON.parse(JSON.stringify(shapes)));
      historyStep = history.length - 1;
      
      if (history.length > 50) {
        history.shift();
        historyStep--;
      }
    }

    function undo() {
      if (historyStep > 0) {
        historyStep--;
        shapes = JSON.parse(JSON.stringify(history[historyStep]));
        selectedShape = null;
        updateShapesList();
        redraw();
        showNotification('AnnulÃ©', 'info');
      }
    }

    function redo() {
      if (historyStep < history.length - 1) {
        historyStep++;
        shapes = JSON.parse(JSON.stringify(history[historyStep]));
        selectedShape = null;
        updateShapesList();
        redraw();
        showNotification('Refait', 'info');
      }
    }

    function zoomIn() {
      zoom = Math.min(zoom * 1.2, 5);
      redraw();
    }

    function zoomOut() {
      zoom = Math.max(zoom * 0.8, 0.1);
      redraw();
    }

    function resetZoom() {
      zoom = 1;
      panX = 0;
      panY = 0;
      redraw();
    }

    function updateZoomDisplay() {
      const zoomPercent = Math.round(zoom * 100) + '%';
      document.getElementById('zoom-display').textContent = zoomPercent;
      document.getElementById('status-zoom').textContent = zoomPercent;
    }

    function applySettings() {
      sheetConfig.width = parseInt(document.getElementById('sheet-width').value) || 1000;
      sheetConfig.height = parseInt(document.getElementById('sheet-height').value) || 600;
      sheetConfig.thickness = parseFloat(document.getElementById('sheet-thickness').value) || 2;
      
      resizeCanvas();
      showNotification('Configuration appliquÃ©e', 'success');
    }

    function toggleTheme() {
      document.body.classList.toggle('dark');
      const icon = document.getElementById('theme-icon');
      icon.className = document.body.classList.contains('dark') ? 'fas fa-sun' : 'fas fa-moon';
      redraw();
    }

    function saveProject() {
      const projectData = {
        name: document.getElementById('project-name').textContent,
        shapes: shapes,
        sheetConfig: sheetConfig,
        savedAt: new Date().toISOString()
      };
      
      localStorage.setItem('steelsketch_project', JSON.stringify(projectData));
      showNotification('Projet sauvegardÃ©', 'success');
    }

    function exportProject() {
      const projectData = {
        name: document.getElementById('project-name').textContent,
        shapes: shapes,
        sheetConfig: sheetConfig,
        exportDate: new Date().toISOString()
      };
      
      const dataStr = JSON.stringify(projectData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      
      const link = document.createElement('a');
      link.href = URL.createObjectURL(dataBlob);
      link.download = `projet_steelsketch_${Date.now()}.json`;
      link.click();
      
      URL.revokeObjectURL(link.href);
      showNotification('Projet exportÃ©', 'success');
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      
      const icons = {
        success: 'fas fa-check-circle',
        error: 'fas fa-exclamation-triangle',
        warning: 'fas fa-exclamation-circle',
        info: 'fas fa-info-circle'
      };
      
      notification.innerHTML = `
        <i class="${icons[type] || icons.info}"></i>
        ${message}
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease forwards';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    window.addEventListener('DOMContentLoaded', () => {
      init();
      saveToHistory();
    });
  </script>
</body>
</html>
