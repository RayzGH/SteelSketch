Voici le script terminé. J'ai complété la fonction `getToolDisplayName`, ajouté les fonctions manquantes pour rendre l'application fonctionnelle (comme la gestion du déplacement, les notifications, l'historique, le thème, les modals, etc.), et implémenté une logique basique pour les outils "polygon" et "cut-curve" avec clics multiples (cliquez pour ajouter des points, double-cliquez pour terminer la forme). J'ai aussi ajouté la gestion du déplacement pour tous les types de formes, y compris les multi-points.

<xaiArtifact title="index.html" contentType="text/html">
<![CDATA[
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>SteelSketch - Logiciel de Découpe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #1e40af;
      --primary-hover: #1d4ed8;
      --secondary: #64748b;
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --text: #0f172a;
      --text-secondary: #64748b;
      --border: #e2e8f0;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
      --success: #22c55e;
      --warning: #facc15;
      --danger: #ef4444;
      --info: #3b82f6;
      --toolbar-h: 70px;
      --sidebar-w: 280px;
      --explorer-w: 300px;
      --grid-color: #e2e8f0;
      --canvas-bg: #ffffff;
    }

    body.dark {
      --bg: #0f172a;
      --card-bg: #1e293b;
      --text: #f8fafc;
      --text-secondary: #94a3b8;
      --border: #475569;
      --primary: #60a5fa;
      --primary-hover: #3b82f6;
      --grid-color: #374151;
      --canvas-bg: #1e293b;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: all 0.3s ease;
      overflow: hidden;
      height: 100vh;
    }

    /* Header */
    header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: var(--toolbar-h);
      background: linear-gradient(270deg, var(--primary), #0ea5e9, var(--primary));
      background-size: 400% 400%;
      animation: headerGradient 10s ease infinite;
      color: white;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow-md);
      z-index: 1000;
    }

    @keyframes headerGradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .logo {
      font-size: 24px;
      font-weight: 700;
      letter-spacing: -0.5px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-center {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
    }

    .project-name {
      font-size: 18px;
      font-weight: 600;
      background: rgba(255,255,255,0.1);
      padding: 8px 16px;
      border-radius: 20px;
      backdrop-filter: blur(10px);
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    .header-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
      padding: 8px 15px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 5px;
      backdrop-filter: blur(10px);
    }

    .header-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-1px);
    }

    .header-btn.save { background: var(--success); }
    .header-btn.import { background: var(--info); }
    .header-btn.export { background: var(--warning); }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .theme-toggle {
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      padding: 10px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .theme-toggle:hover {
      background: rgba(255,255,255,0.3);
      transform: scale(1.1);
    }

    /* Sidebar Amis */

    .friends-sidebar {
      position: fixed;
      left: 0;
      top: var(--toolbar-h);
      width: var(--sidebar-w);
      height: calc(100vh - var(--toolbar-h));
      background: var(--card-bg);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      transition: transform 0.3s ease;
      z-index: 900;
      box-shadow: var(--shadow-sm);
    }

    .friends-sidebar.hidden {
      transform: translateX(-100%);
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
    }

    .sidebar-tabs {
      display: flex;
      gap: 5px;
      background: var(--card-bg);
      border-radius: 8px;
      padding: 4px;
    }

    .sidebar-tab {
      flex: 1;
      padding: 8px 12px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .sidebar-tab.active {
      background: var(--primary);
      color: white;
    }

    .sidebar-content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .friend-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 8px;
    }

    .friend-item:hover {
      background: var(--bg);
      transform: translateX(5px);
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      position: relative;
    }

    .status-indicator.online {
      background: var(--success);
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.4);
    }

    .friend-name {
      flex: 1;
      font-weight: 500;
      font-size: 14px;
    }

    /* Explorer */
    .explorer {
      position: fixed;
      right: 0;
      top: var(--toolbar-h);
      width: var(--explorer-w);
      height: calc(100vh - var(--toolbar-h));
      background: var(--card-bg);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      transition: transform 0.3s ease;
      z-index: 900;
      box-shadow: var(--shadow-sm);
    }

    .explorer.hidden {
      transform: translateX(100%);
    }

    .explorer-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
    }

    .explorer-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .explorer-content {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
    }

    .tree-view {
      font-size: 14px;
    }

    .tree-item {
      display: flex;
      align-items: center;
      padding: 6px 8px;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.3s ease;
      user-select: none;
    }

    .tree-item:hover {
      background: var(--bg);
    }

    .tree-item.selected {
      background: var(--primary);
      color: white;
    }

    .tree-indent {
      width: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .tree-toggle {
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border-radius: 3px;
      transition: all 0.3s ease;
    }

    .tree-toggle:hover {
      background: var(--border);
    }

    .tree-toggle i {
      font-size: 10px;
      transition: transform 0.3s ease;
    }

    .tree-toggle.expanded i {
      transform: rotate(90deg);
    }

    .tree-icon {
      margin-right: 8px;
      color: var(--text-secondary);
    }

    .tree-children {
      margin-left: 20px;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .tree-children.expanded {
      max-height: 1000px;
    }

    /* Workspace */
    .workspace {
      position: fixed;
      left: var(--sidebar-w);
      top: var(--toolbar-h);
      right: var(--explorer-w);
      bottom: 0;
      background: var(--card-bg);
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
    }

    .workspace.friends-hidden {
      left: 0;
    }

    .workspace.explorer-hidden {
      right: 0;
    }

    .workspace-toolbar {
      height: 60px;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 20px;
      gap: 15px;
    }

    .tool-group {
      display: flex;
      gap: 8px;
      align-items: center;
      padding-right: 15px;
      border-right: 1px solid var(--border);
    }

    .tool-group:last-child {
      border-right: none;
    }

    .tool-btn {
      width: 40px;
      height: 40px;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text);
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      position: relative;
    }

    .tool-btn:hover {
      background: var(--primary);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3);
    }

    .tool-btn.active {
      background: var(--primary);
      color: white;
      box-shadow: 0 0 15px rgba(30, 64, 175, 0.4);
    }

    .canvas-container {
      flex: 1;
      position: relative;
      overflow: hidden;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #mainCanvas {
      background: var(--canvas-bg);
      border: 2px solid var(--border);
      border-radius: 8px;
      box-shadow: var(--shadow-md);
      cursor: crosshair;
    }

    /* Toggles */
    .sidebar-toggle, .explorer-toggle {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: var(--card-bg);
      border: 1px solid var(--border);
      padding: 8px;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s ease;
      color: var(--text);
      z-index: 10;
    }

    .sidebar-toggle {
      right: -15px;
      border-left: none;
      border-radius: 0 8px 8px 0;
    }

    .explorer-toggle {
      left: -15px;
      border-right: none;
      border-radius: 8px 0 0 8px;
    }

    .sidebar-toggle:hover, .explorer-toggle:hover {
      background: var(--primary);
      color: white;
    }

    /* Properties Panel */
    .properties-panel {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 280px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      box-shadow: var(--shadow-md);
      max-height: 400px;
      overflow-y: auto;
    }

    .properties-panel.hidden {
      display: none;
    }

    .property-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .property-group {
      margin-bottom: 15px;
    }

    .property-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 5px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .property-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
      background: var(--card-bg);
      color: var(--text);
      transition: border-color 0.3s ease;
    }

    .property-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .property-row {
      display: flex;
      gap: 10px;
    }

    .property-row .property-input {
      flex: 1;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
      z-index: 2000;
      animation: fadeIn 0.3s;
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background: var(--card-bg);
      padding: 30px;
      border-radius: 16px;
      box-shadow: var(--shadow-md);
      width: 500px;
      max-width: 90vw;
      animation: scaleIn 0.3s;
      position: relative;
      border: 1px solid var(--border);
    }

    .modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      cursor: pointer;
      font-size: 16px;
      color: var(--text-secondary);
      padding: 8px;
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    .modal-close:hover {
      background: var(--bg);
      color: var(--text);
    }

    .modal h3 {
      margin-bottom: 20px;
      font-size: 20px;
      font-weight: 600;
      color: var(--text);
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: var(--text);
      font-size: 14px;
    }

    .form-input, .form-select {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      background: var(--card-bg);
      color: var(--text);
      transition: border-color 0.3s ease;
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .form-row {
      display: flex;
      gap: 15px;
    }

    .form-row .form-group {
      flex: 1;
    }

    .modal-btn {
      width: 100%;
      padding: 15px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .modal-btn:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }

    /* Toolbar info */
    .toolbar-info {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 20px;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .zoom-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .zoom-display {
      background: var(--card-bg);
      border: 1px solid var(--border);
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: 500;
      min-width: 60px;
      text-align: center;
    }

    /* Notifications */
    .notification {
      position: fixed;
      top: 90px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: var(--shadow-md);
      z-index: 3000;
      animation: slideInRight 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 500;
      min-width: 280px;
    }

    .notification.success { background: var(--success); color: white; }
    .notification.error { background: var(--danger); color: white; }
    .notification.info { background: var(--info); color: white; }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes scaleIn {
      from { transform: scale(0.95); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .friends-sidebar, .explorer {
        width: 250px;
      }
    }

    @media (max-width: 768px) {
      .friends-sidebar, .explorer {
        position: fixed;
        width: 100vw;
        z-index: 1500;
      }
      
      .workspace {
        left: 0 !important;
        right: 0 !important;
      }
      
      .header-center {
        display: none;
      }
      
      .properties-panel {
        position: relative;
        width: 100%;
        margin: 10px;
        bottom: auto;
        right: auto;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="logo">
      <i class="fas fa-cube"></i>
      SteelSketch
    </div>
    <div class="header-center">
      <div class="project-name" id="project-name">Nouveau Projet</div>
      <div class="header-actions">
        <button class="header-btn" onclick="undoAction()" title="Annuler (Ctrl+Z)">
          <i class="fas fa-undo"></i>
        </button>
        <button class="header-btn" onclick="redoAction()" title="Refaire (Ctrl+Y)">
          <i class="fas fa-redo"></i>
        </button>
        <button class="header-btn save" onclick="saveProject()" title="Sauvegarder (Ctrl+S)">
          <i class="fas fa-save"></i>
        </button>
        <button class="header-btn import" onclick="importProject()" title="Importer">
          <i class="fas fa-upload"></i>
        </button>
        <button class="header-btn export" onclick="exportProject()" title="Exporter">
          <i class="fas fa-download"></i>
        </button>
      </div>
    </div>
    <div class="user-info">
      <button class="theme-toggle" onclick="toggleTheme()" title="Basculer le thème">
        <i class="fas fa-moon" id="theme-icon"></i>
      </button>
      <div class="user-avatar"><i class="fas fa-user"></i></div>
      <span id="user-name">Utilisateur</span>
    </div>
  </header>

  <!-- Sidebar Amis -->
  <div class="friends-sidebar" id="friends-sidebar">
    <button class="sidebar-toggle" onclick="toggleFriendsSidebar()">
      <i class="fas fa-chevron-left" id="friends-toggle-icon"></i>
    </button>
    
    <div class="sidebar-header">
      <div class="sidebar-tabs">
        <button class="sidebar-tab active" onclick="switchTab('online')">
          <i class="fas fa-circle"></i> En ligne
        </button>
        <button class="sidebar-tab" onclick="switchTab('invite')">
          <i class="fas fa-paper-plane"></i> Inviter
        </button>
      </div>
    </div>

    <div class="sidebar-content">
      <div id="online-tab" class="tab-content">
        <div class="section-title">
          <i class="fas fa-users"></i>
          Amis connectés (3)
        </div>
        <div id="online-friends">
          <div class="friend-item">
            <div class="status-indicator online"></div>
            <div class="friend-name">Jean Dupont</div>
          </div>
          <div class="friend-item">
            <div class="status-indicator online"></div>
            <div class="friend-name">Marie Martin</div>
          </div>
          <div class="friend-item">
            <div class="status-indicator online"></div>
            <div class="friend-name">Paul Durand</div>
          </div>
        </div>
      </div>

      <div id="invite-tab" class="tab-content" style="display: none;">
        <div class="section-title">
          <i class="fas fa-paper-plane"></i>
          Inviter des collaborateurs
        </div>
        <div style="margin-bottom: 20px;">
          <input type="text" class="property-input" placeholder="Email ou nom d'utilisateur..." id="invite-input">
          <button class="modal-btn" onclick="sendInvite()" style="margin-top: 10px;">
            <i class="fas fa-plus"></i> Envoyer l'invitation
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Explorer -->
  <div class="explorer" id="explorer">
    <button class="explorer-toggle" onclick="toggleExplorer()">
      <i class="fas fa-chevron-right" id="explorer-toggle-icon"></i>
    </button>
    
    <div class="explorer-header">
      <div class="explorer-title">
        <i class="fas fa-sitemap"></i>
        Hiérarchie du projet
      </div>
    </div>

    <div class="explorer-content">
      <div class="tree-view" id="tree-view">
        <!-- Structure sera générée dynamiquement -->
      </div>
    </div>
  </div>

  <!-- Workspace -->
  <div class="workspace" id="workspace">
    <div class="workspace-toolbar">
      <div class="tool-group">
        <button class="tool-btn active" data-tool="select" title="Sélection (S)">
          <i class="fas fa-mouse-pointer"></i>
        </button>
        <button class="tool-btn" data-tool="move" title="Déplacer (M)">
          <i class="fas fa-arrows-alt"></i>
        </button>
      </div>
      
      <div class="tool-group">
        <button class="tool-btn" data-tool="rectangle" title="Rectangle (R)">
          <i class="fas fa-square"></i>
        </button>
        <button class="tool-btn" data-tool="circle" title="Cercle (C)">
          <i class="fas fa-circle"></i>
        </button>
        <button class="tool-btn" data-tool="line" title="Ligne (L)">
          <i class="fas fa-minus"></i>
        </button>
        <button class="tool-btn" data-tool="polygon" title="Polygone (P)">
          <i class="fas fa-draw-polygon"></i>
        </button>
      </div>
      
      <div class="tool-group">
        <button class="tool-btn" data-tool="cut-line" title="Découpe droite">
          <i class="fas fa-cut"></i>
        </button>
        <button class="tool-btn" data-tool="cut-curve" title="Découpe courbe">
          <i class="fas fa-bezier-curve"></i>
        </button>
        <button class="tool-btn" data-tool="drill" title="Perçage (D)">
          <i class="fas fa-circle-dot"></i>
        </button>
      </div>
      
      <div class="tool-group">
        <button class="tool-btn" onclick="newSheet()" title="Nouvelle tôle">
          <i class="fas fa-file"></i>
        </button>
        <button class="tool-btn" onclick="openSheetSettings()" title="Paramètres tôle">
          <i class="fas fa-cog"></i>
        </button>
      </div>

      <div class="toolbar-info">
        <div class="zoom-controls">
          <button class="tool-btn" onclick="zoomOut()" title="Zoom - (Ctrl+-)">
            <i class="fas fa-search-minus"></i>
          </button>
          <div class="zoom-display" id="zoom-display">100%</div>
          <button class="tool-btn" onclick="zoomIn()" title="Zoom + (Ctrl++)">
            <i class="fas fa-search-plus"></i>
          </button>
          <button class="tool-btn" onclick="fitToScreen()" title="Ajuster (Ctrl+0)">
            <i class="fas fa-expand-arrows-alt"></i>
          </button>
        </div>
        <div>Grille: <span id="grid-size">10mm</span></div>
        <div>Position: <span id="cursor-pos">0, 0</span></div>
      </div>
    </div>

    <div class="canvas-container" id="canvas-container">
      <canvas id="mainCanvas"></canvas>
    </div>

    <!-- Panneau de propriétés -->
    <div class="properties-panel hidden" id="properties-panel">
      <div class="property-title">
        <i class="fas fa-sliders-h"></i>
        Propriétés
      </div>
      
      <div class="property-group">
        <div class="property-label">Position (mm)</div>
        <div class="property-row">
          <input type="number" class="property-input" placeholder="X" id="prop-x" step="0.1">
          <input type="number" class="property-input" placeholder="Y" id="prop-y" step="0.1">
        </div>
      </div>
      
      <div class="property-group">
        <div class="property-label">Dimensions (mm)</div>
        <div class="property-row">
          <input type="number" class="property-input" placeholder="L" id="prop-width" step="0.1">
          <input type="number" class="property-input" placeholder="H" id="prop-height" step="0.1">
        </div>
      </div>
      
      <div class="property-group">
        <div class="property-label">Style</div>
        <input type="color" class="property-input" id="prop-color" value="#1e40af">
      </div>
      
      <div class="property-group">
        <div class="property-label">Rotation (°)</div>
        <input type="number" class="property-input" id="prop-rotation" value="0" step="1" min="0" max="360">
      </div>
      
      <div class="property-group">
        <div class="property-label">Épaisseur (mm)</div>
        <input type="number" class="property-input" id="prop-thickness" value="2" step="0.1" min="0.1">
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button class="modal-btn" onclick="duplicateSelected()" style="flex: 1; font-size: 14px; padding: 10px;">
          <i class="fas fa-copy"></i> Dupliquer
        </button>
        <button class="modal-btn" onclick="deleteSelected()" style="flex: 1; font-size: 14px; padding: 10px; background: var(--danger);">
          <i class="fas fa-trash"></i> Supprimer
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Paramètres Tôle -->
  <div id="sheet-settings-modal" class="modal">
    <div class="modal-content">
      <i class="fas fa-times modal-close" onclick="closeModal()"></i>
      <h3><i class="fas fa-cog"></i> Paramètres de la tôle</h3>
      
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Largeur (mm)</label>
          <input type="number" class="form-input" id="sheet-width" value="1000" min="100" step="10">
        </div>
        <div class="form-group">
          <label class="form-label">Hauteur (mm)</label>
          <input type="number" class="form-input" id="sheet-height" value="600" min="100" step="10">
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Épaisseur (mm)</label>
          <input type="number" class="form-input" id="sheet-thickness" value="2" min="0.1" step="0.1">
        </div>
        <div class="form-group">
          <label class="form-label">Taille grille (mm)</label>
          <input type="number" class="form-input" id="grid-size-input" value="10" min="1" step="1">
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Matériau</label>
        <select class="form-select" id="sheet-material">
          <option value="steel">Acier inoxydable</option>
          <option value="aluminum">Aluminium</option>
          <option value="carbon">Acier carbone</option>
          <option value="brass">Laiton</option>
          <option value="copper">Cuivre</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">Couleur de la tôle</label>
        <input type="color" class="form-input" id="sheet-color" value="#e2e8f0">
      </div>
      
      <button class="modal-btn" onclick="applySheetSettings()">
        <i class="fas fa-check"></i> Appliquer les paramètres
      </button>
    </div>
  </div>

  <!-- Firebase + Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // Configuration Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyB3jjwsFcv3-gbc6ZqEyMuzfMs97SSJeE8",
      authDomain: "steelsketch-b7264.firebaseapp.com",
      projectId: "steelsketch-b7264",
      storageBucket: "steelsketch-b7264.firebasestorage.app",
      messagingSenderId: "424606073739",
      appId: "1:424606073739:web:696f400e992a50d7bee58e",
      measurementId: "G-TD79BYQ5P6"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Variables globales
    let canvas, ctx;
    let currentTool = 'select';
    let selectedElement = null;
    let isDrawing = false;
    let isDragging = false;
    let startX = 0, startY = 0;
    let shapes = [];
    let history = [];
    let historyStep = 0;
    let zoom = 1;
    let panX = 0, panY = 0;
    let gridSize = 10; // mm
    let pixelsPerMM = 2; // 2 pixels = 1mm par défaut
    let friendsSidebarOpen = true;
    let explorerOpen = true;
    let isDarkMode = false;
    let currentPoints = [];
    let initialShape = null;

    // Configuration de la tôle
    let sheetConfig = {
      width: 1000, // mm
      height: 600, // mm
      thickness: 2, // mm
      material: 'steel',
      color: '#e2e8f0'
    };

    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
      initAuth();
      initCanvas();
      initEventListeners();
      initTreeView();
      loadExampleShapes();
      showNotification('SteelSketch chargé avec succès!', 'success');
    });

    function initAuth() {
      auth.onAuthStateChanged((user) => {
        if (user) {
          document.getElementById('user-name').textContent = user.displayName || user.email.split('@')[0];
        } else {
          window.location.href = 'index.html';
        }
      });
    }

    function initCanvas() {
      canvas = document.getElementById('mainCanvas');
      ctx = canvas.getContext('2d');
      
      // Taille initiale du canvas
      resizeCanvas();
      
      // Événements canvas
      canvas.addEventListener('mousedown', handleMouseDown);
      canvas.addEventListener('mousemove', handleMouseMove);
      canvas.addEventListener('mouseup', handleMouseUp);
      canvas.addEventListener('wheel', handleWheel, { passive: false });
      canvas.addEventListener('contextmenu', e => e.preventDefault());
      canvas.addEventListener('dblclick', handleDoubleClick);
      
      // Redimensionnement
      window.addEventListener('resize', resizeCanvas);
      
      // Première render
      redrawCanvas();
    }

    function initEventListeners() {
      // Outils
      document.querySelectorAll('.tool-btn[data-tool]').forEach(btn => {
        btn.addEventListener('click', () => {
          selectTool(btn.getAttribute('data-tool'));
        });
      });

      // Inputs de propriétés
      ['prop-x', 'prop-y', 'prop-width', 'prop-height', 'prop-color', 'prop-rotation', 'prop-thickness'].forEach(id => {
        const input = document.getElementById(id);
        if (input) {
          input.addEventListener('input', updateSelectedElement);
        }
      });

      // Raccourcis clavier
      document.addEventListener('keydown', handleKeyboard);
    }

    function resizeCanvas() {
      const container = document.getElementById('canvas-container');
      const rect = container.getBoundingClientRect();
      
      // Calcul de la taille optimale
      const padding = 100;
      const maxWidth = rect.width - padding;
      const maxHeight = rect.height - padding;
      
      // Conversion mm vers pixels
      const sheetWidthPx = sheetConfig.width * pixelsPerMM * zoom;
      const sheetHeightPx = sheetConfig.height * pixelsPerMM * zoom;
      
      // Ajustement pour tenir dans la fenêtre
      let canvasWidth = sheetWidthPx + 200; // Marge pour la grille
      let canvasHeight = sheetHeightPx + 200;
      
      if (canvasWidth > maxWidth) {
        const scale = maxWidth / canvasWidth;
        canvasWidth = maxWidth;
        canvasHeight *= scale;
      }
      
      if (canvasHeight > maxHeight) {
        const scale = maxHeight / canvasHeight;
        canvasHeight = maxHeight;
        canvasWidth *= scale;
      }
      
      canvas.width = canvasWidth;
      canvas.height = canvasHeight;
      
      redrawCanvas();
    }

    function redrawCanvas() {
      // Clear canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Sauvegarder l'état
      ctx.save();
      
      // Appliquer zoom et pan
      ctx.scale(zoom, zoom);
      ctx.translate(panX, panY);
      
      // Dessiner la grille
      drawGrid();
      
      // Dessiner la tôle
      drawSheet();
      
      // Dessiner toutes les formes
      shapes.forEach(shape => drawShape(shape));
      
      // Dessiner la sélection
      if (selectedElement) {
        drawSelection(selectedElement);
      }
      
      // Restaurer l'état
      ctx.restore();
      
      // Mettre à jour l'affichage du zoom
      document.getElementById('zoom-display').textContent = Math.round(zoom * 100) + '%';
    }

    function drawGrid() {
      const gridSizePx = gridSize * pixelsPerMM;
      const canvasWidthScaled = canvas.width / zoom;
      const canvasHeightScaled = canvas.height / zoom;
      
      ctx.strokeStyle = isDarkMode ? '#374151' : '#e2e8f0';
      ctx.lineWidth = 0.5;
      ctx.setLineDash([]);
      
      // Lignes verticales
      for (let x = 0; x < canvasWidthScaled; x += gridSizePx) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvasHeightScaled);
        ctx.stroke();
      }
      
      // Lignes horizontales
      for (let y = 0; y < canvasHeightScaled; y += gridSizePx) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvasWidthScaled, y);
        ctx.stroke();
      }
      
      // Grille principale tous les 50mm
      ctx.strokeStyle = isDarkMode ? '#4b5563' : '#cbd5e1';
      ctx.lineWidth = 1;
      
      const majorGridSize = gridSizePx * 5;
      
      for (let x = 0; x < canvasWidthScaled; x += majorGridSize) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvasHeightScaled);
        ctx.stroke();
      }
      
      for (let y = 0; y < canvasHeightScaled; y += majorGridSize) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvasWidthScaled, y);
        ctx.stroke();
      }
    }

    function drawSheet() {
      const sheetX = 100;
      const sheetY = 100;
      const sheetWidthPx = sheetConfig.width * pixelsPerMM;
      const sheetHeightPx = sheetConfig.height * pixelsPerMM;
      
      // Fond de la tôle
      ctx.fillStyle = sheetConfig.color;
      ctx.fillRect(sheetX, sheetY, sheetWidthPx, sheetHeightPx);
      
      // Contour de la tôle
      ctx.strokeStyle = '#1e40af';
      ctx.lineWidth = 3;
      ctx.setLineDash([]);
      ctx.strokeRect(sheetX, sheetY, sheetWidthPx, sheetHeightPx);
      
      // Dimensions (affichage)
      ctx.fillStyle = '#374151';
      ctx.font = '12px Inter';
      ctx.textAlign = 'center';
      
      // Largeur
      ctx.fillText(`${sheetConfig.width}mm`, sheetX + sheetWidthPx/2, sheetY - 10);
      
      // Hauteur
      ctx.save();
      ctx.translate(sheetX - 20, sheetY + sheetHeightPx/2);
      ctx.rotate(-Math.PI/2);
      ctx.fillText(`${sheetConfig.height}mm`, 0, 0);
      ctx.restore();
    }

    function drawShape(shape) {
      const sheetX = 100;
      const sheetY = 100;
      
      ctx.strokeStyle = shape.color || '#1e40af';
      ctx.fillStyle = shape.color || '#1e40af';
      ctx.lineWidth = shape.lineWidth || 2;
      ctx.setLineDash(shape.type.includes('cut') ? [5, 5] : []);
      
      const x = sheetX + (shape.x * pixelsPerMM);
      const y = sheetY + (shape.y * pixelsPerMM);
      
      ctx.save();
      
      // Rotation si nécessaire
      if (shape.rotation && !shape.points) {
        const centerX = x + (shape.width || shape.radius || 0) * pixelsPerMM / 2;
        const centerY = y + (shape.height || shape.radius || 0) * pixelsPerMM / 2;
        ctx.translate(centerX, centerY);
        ctx.rotate(shape.rotation * Math.PI / 180);
        ctx.translate(-centerX, -centerY);
      }
      
      switch (shape.type) {
        case 'rectangle':
          const widthPx = shape.width * pixelsPerMM;
          const heightPx = shape.height * pixelsPerMM;
          ctx.strokeRect(x, y, widthPx, heightPx);
          if (shape.filled) {
            ctx.globalAlpha = 0.3;
            ctx.fillRect(x, y, widthPx, heightPx);
            ctx.globalAlpha = 1;
          }
          break;
          
        case 'circle':
          const radiusPx = shape.radius * pixelsPerMM;
          ctx.beginPath();
          ctx.arc(x + radiusPx, y + radiusPx, radiusPx, 0, 2 * Math.PI);
          ctx.stroke();
          if (shape.filled) {
            ctx.globalAlpha = 0.3;
            ctx.fill();
            ctx.globalAlpha = 1;
          }
          break;
          
        case 'line':
          const x2 = sheetX + (shape.x2 * pixelsPerMM);
          const y2 = sheetY + (shape.y2 * pixelsPerMM);
          ctx.beginPath();
          ctx.moveTo(x, y);
          ctx.lineTo(x2, y2);
          ctx.stroke();
          break;
          
        case 'cut-line':
          const x2Cut = sheetX + (shape.x2 * pixelsPerMM);
          const y2Cut = sheetY + (shape.y2 * pixelsPerMM);
          ctx.strokeStyle = '#ef4444';
          ctx.beginPath();
          ctx.moveTo(x, y);
          ctx.lineTo(x2Cut, y2Cut);
          ctx.stroke();
          break;
          
        case 'drill':
          const drillRadiusPx = (shape.radius || 2.5) * pixelsPerMM;
          ctx.fillStyle = '#ef4444';
          ctx.beginPath();
          ctx.arc(x, y, drillRadiusPx, 0, 2 * Math.PI);
          ctx.fill();
          ctx.strokeStyle = '#dc2626';
          ctx.stroke();
          break;
          
        case 'polygon':
        case 'cut-curve':
          ctx.beginPath();
          shape.points.forEach((p, i) => {
            const px = sheetX + p.x * pixelsPerMM;
            const py = sheetY + p.y * pixelsPerMM;
            if (i === 0) ctx.moveTo(px, py);
            else ctx.lineTo(px, py);
          });
          if (shape.type === 'polygon') ctx.closePath();
          ctx.stroke();
          if (shape.type === 'polygon' && shape.filled) {
            ctx.globalAlpha = 0.3;
            ctx.fill();
            ctx.globalAlpha = 1;
          }
          break;
      }
      
      ctx.restore();
    }

    function drawSelection(shape) {
      const sheetX = 100;
      const sheetY = 100;
      
      ctx.strokeStyle = '#22c55e';
      ctx.lineWidth = 2;
      ctx.setLineDash([5, 5]);
      
      const bounds = getShapeBounds(shape);
      const x = sheetX + (bounds.x * pixelsPerMM) - 5;
      const y = sheetY + (bounds.y * pixelsPerMM) - 5;
      const width = bounds.width * pixelsPerMM + 10;
      const height = bounds.height * pixelsPerMM + 10;
      
      ctx.strokeRect(x, y, width, height);
      
      // Points de contrôle
      ctx.fillStyle = '#22c55e';
      ctx.fillRect(x - 3, y - 3, 6, 6);
      ctx.fillRect(x + width - 3, y - 3, 6, 6);
      ctx.fillRect(x - 3, y + height - 3, 6, 6);
      ctx.fillRect(x + width - 3, y + height - 3, 6, 6);
      
      ctx.setLineDash([]);
    }

    function getShapeBounds(shape) {
      switch (shape.type) {
        case 'rectangle':
          return { x: shape.x, y: shape.y, width: shape.width, height: shape.height };
        case 'circle':
          return { 
            x: shape.x, 
            y: shape.y, 
            width: shape.radius * 2, 
            height: shape.radius * 2 
          };
        case 'line':
        case 'cut-line':
          return {
            x: Math.min(shape.x, shape.x2),
            y: Math.min(shape.y, shape.y2),
            width: Math.abs(shape.x2 - shape.x),
            height: Math.abs(shape.y2 - shape.y)
          };
        case 'drill':
          const radius = shape.radius || 2.5;
          return {
            x: shape.x - radius,
            y: shape.y - radius,
            width: radius * 2,
            height: radius * 2
          };
        case 'polygon':
        case 'cut-curve':
          const minX = Math.min(...shape.points.map(p => p.x));
          const minY = Math.min(...shape.points.map(p => p.y));
          const maxX = Math.max(...shape.points.map(p => p.x));
          const maxY = Math.max(...shape.points.map(p => p.y));
          return { x: minX, y: minY, width: maxX - minX, height: maxY - minY };
        default:
          return { x: 0, y: 0, width: 0, height: 0 };
      }
    }

    function handleMouseDown(e) {
      const rect = canvas.getBoundingClientRect();
      const mouseX = (e.clientX - rect.left) / zoom - panX;
      const mouseY = (e.clientY - rect.top) / zoom - panY;
      
      // Conversion en coordonnées tôle
      const sheetX = 100;
      const sheetY = 100;
      startX = (mouseX - sheetX) / pixelsPerMM;
      startY = (mouseY - sheetY) / pixelsPerMM;
      
      if (currentTool === 'select') {
        selectedElement = findShapeAtPoint(startX, startY);
        updatePropertiesPanel();
        redrawCanvas();
      } else if (currentTool === 'move') {
        selectedElement = findShapeAtPoint(startX, startY);
        if (selectedElement) {
          updatePropertiesPanel();
          isDragging = true;
          initialShape = JSON.parse(JSON.stringify(selectedElement));
        }
      } else if (currentTool === 'polygon' || currentTool === 'cut-curve') {
        currentPoints.push({x: startX, y: startY});
        redrawCanvas();
      } else {
        isDrawing = true;
      }
    }

    function handleMouseMove(e) {
      const rect = canvas.getBoundingClientRect();
      const mouseX = (e.clientX - rect.left) / zoom - panX;
      const mouseY = (e.clientY - rect.top) / zoom - panY;
      
      // Conversion en coordonnées tôle
      const sheetX = 100;
      const sheetY = 100;
      const currentX = (mouseX - sheetX) / pixelsPerMM;
      const currentY = (mouseY - sheetY) / pixelsPerMM;
      
      // Mise à jour position curseur
      document.getElementById('cursor-pos').textContent = `${Math.round(currentX)}, ${Math.round(currentY)}`;
      
      if (isDrawing && currentTool !== 'select' && currentTool !== 'move') {
        redrawCanvas();
        drawPreview(startX, startY, currentX, currentY);
      } else if (isDragging) {
        const dx = currentX - startX;
        const dy = currentY - startY;
        const snappedDx = Math.round(dx / gridSize) * gridSize;
        const snappedDy = Math.round(dy / gridSize) * gridSize;
        if (selectedElement.type === 'rectangle' || selectedElement.type === 'circle' || selectedElement.type === 'drill') {
          selectedElement.x = initialShape.x + snappedDx;
          selectedElement.y = initialShape.y + snappedDy;
        } else if (selectedElement.type === 'line' || selectedElement.type === 'cut-line') {
          selectedElement.x = initialShape.x + snappedDx;
          selectedElement.y = initialShape.y + snappedDy;
          selectedElement.x2 = initialShape.x2 + snappedDx;
          selectedElement.y2 = initialShape.y2 + snappedDy;
        } else if (selectedElement.type === 'polygon' || selectedElement.type === 'cut-curve') {
          selectedElement.points = initialShape.points.map(p => ({
            x: p.x + snappedDx,
            y: p.y + snappedDy
          }));
        }
        redrawCanvas();
      } else if (currentPoints.length > 0) {
        redrawCanvas();
        drawPreviewMultiPoint(currentX, currentY);
      }
    }

    function handleMouseUp(e) {
      if (isDrawing) {
        const rect = canvas.getBoundingClientRect();
        const mouseX = (e.clientX - rect.left) / zoom - panX;
        const mouseY = (e.clientY - rect.top) / zoom - panY;
        
        const sheetX = 100;
        const sheetY = 100;
        const endX = (mouseX - sheetX) / pixelsPerMM;
        const endY = (mouseY - sheetY) / pixelsPerMM;
        
        createShape(startX, startY, endX, endY);
        isDrawing = false;
      } else if (isDragging) {
        isDragging = false;
        initialShape = null;
        saveHistory();
      }
      redrawCanvas();
    }

    function handleDoubleClick(e) {
      if (currentTool === 'polygon' || currentTool === 'cut-curve') {
        if (currentPoints.length < 2) return;
        createMultiPointShape();
      }
    }

    function handleWheel(e) {
      e.preventDefault();
      
      const rect = canvas.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;
      
      const zoomFactor = e.deltaY < 0 ? 1.1 : 0.9;
      const newZoom = Math.max(0.1, Math.min(5, zoom * zoomFactor));
      
      // Zoom centré sur la souris
      const dx = mouseX / zoom - mouseX / newZoom;
      const dy = mouseY / zoom - mouseY / newZoom;
      
      panX += dx;
      panY += dy;
      zoom = newZoom;
      
      redrawCanvas();
    }

    function drawPreview(x1, y1, x2, y2) {
      const sheetX = 100;
      const sheetY = 100;
      
      ctx.save();
      ctx.strokeStyle = '#94a3b8';
      ctx.lineWidth = 1;
      ctx.setLineDash([3, 3]);
      
      const startXPx = sheetX + x1 * pixelsPerMM;
      const startYPx = sheetY + y1 * pixelsPerMM;
      const endXPx = sheetX + x2 * pixelsPerMM;
      const endYPx = sheetY + y2 * pixelsPerMM;
      
      switch (currentTool) {
        case 'rectangle':
          ctx.strokeRect(startXPx, startYPx, endXPx - startXPx, endYPx - startYPx);
          break;
        case 'circle':
          const radius = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
          const radiusPx = radius * pixelsPerMM;
          ctx.beginPath();
          ctx.arc(startXPx, startYPx, radiusPx, 0, 2 * Math.PI);
          ctx.stroke();
          break;
        case 'line':
        case 'cut-line':
          ctx.beginPath();
          ctx.moveTo(startXPx, startYPx);
          ctx.lineTo(endXPx, endYPx);
          ctx.stroke();
          break;
      }
      
      ctx.restore();
    }

    function drawPreviewMultiPoint(currentX, currentY) {
      const sheetX = 100;
      const sheetY = 100;
      
      ctx.save();
      ctx.strokeStyle = '#94a3b8';
      ctx.lineWidth = 1;
      ctx.setLineDash([3, 3]);
      
      ctx.beginPath();
      currentPoints.forEach((p, i) => {
        const px = sheetX + p.x * pixelsPerMM;
        const py = sheetY + p.y * pixelsPerMM;
        if (i === 0) ctx.moveTo(px, py);
        else ctx.lineTo(px, py);
      });
      if (currentX !== undefined && currentY !== undefined) {
        const px = sheetX + currentX * pixelsPerMM;
        const py = sheetY + currentY * pixelsPerMM;
        ctx.lineTo(px, py);
        if (currentTool === 'polygon' && currentPoints.length > 0) {
          ctx.lineTo(sheetX + currentPoints[0].x * pixelsPerMM, sheetY + currentPoints[0].y * pixelsPerMM);
        }
      }
      ctx.stroke();
      ctx.restore();
    }

    function createShape(x1, y1, x2, y2) {
      // Grille magnétique
      x1 = Math.round(x1 / gridSize) * gridSize;
      y1 = Math.round(y1 / gridSize) * gridSize;
      x2 = Math.round(x2 / gridSize) * gridSize;
      y2 = Math.round(y2 / gridSize) * gridSize;
      
      let newShape = null;
      
      switch (currentTool) {
        case 'rectangle':
          if (Math.abs(x2 - x1) < 5 || Math.abs(y2 - y1) < 5) return;
          newShape = {
            id: generateId(),
            type: 'rectangle',
            x: Math.min(x1, x2),
            y: Math.min(y1, y2),
            width: Math.abs(x2 - x1),
            height: Math.abs(y2 - y1),
            color: '#1e40af',
            rotation: 0,
            thickness: sheetConfig.thickness
          };
          break;
          
        case 'circle':
          const radius = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
          if (radius < 5) return;
          newShape = {
            id: generateId(),
            type: 'circle',
            x: x1 - radius,
            y: y1 - radius,
            radius: radius,
            color: '#1e40af',
            rotation: 0,
            thickness: sheetConfig.thickness
          };
          break;
          
        case 'line':
          if (Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2)) < 10) return;
          newShape = {
            id: generateId(),
            type: 'line',
            x: x1,
            y: y1,
            x2: x2,
            y2: y2,
            color: '#1e40af',
            thickness: sheetConfig.thickness
          };
          break;
          
        case 'cut-line':
          if (Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2)) < 10) return;
          newShape = {
            id: generateId(),
            type: 'cut-line',
            x: x1,
            y: y1,
            x2: x2,
            y2: y2,
            color: '#ef4444',
            thickness: 0.1
          };
          break;
          
        case 'drill':
          newShape = {
            id: generateId(),
            type: 'drill',
            x: x1,
            y: y1,
            radius: 2.5,
            color: '#ef4444'
          };
          break;
      }
      
      if (newShape) {
        shapes.push(newShape);
        selectedElement = newShape;
        saveHistory();
        updatePropertiesPanel();
        updateTreeView();
        showNotification(`${getShapeDisplayName(newShape.type)} créé`, 'success');
      }
    }

    function createMultiPointShape() {
      currentPoints = currentPoints.map(p => ({
        x: Math.round(p.x / gridSize) * gridSize,
        y: Math.round(p.y / gridSize) * gridSize
      }));
      
      let newShape = {
        id: generateId(),
        type: currentTool,
        points: currentPoints,
        color: currentTool === 'polygon' ? '#1e40af' : '#ef4444',
        rotation: 0,
        thickness: currentTool === 'polygon' ? sheetConfig.thickness : 0.1
      };
      
      shapes.push(newShape);
      selectedElement = newShape;
      saveHistory();
      updatePropertiesPanel();
      updateTreeView();
      currentPoints = [];
      showNotification(`${getShapeDisplayName(newShape.type)} créé`, 'success');
    }

    function findShapeAtPoint(x, y) {
      for (let i = shapes.length - 1; i >= 0; i--) {
        const shape = shapes[i];
        if (isPointInShape(x, y, shape)) {
          return shape;
        }
      }
      return null;
    }

    function isPointInShape(x, y, shape) {
      switch (shape.type) {
        case 'rectangle':
          return x >= shape.x && x <= shape.x + shape.width && 
                 y >= shape.y && y <= shape.y + shape.height;
        case 'circle':
          const dx = x - (shape.x + shape.radius);
          const dy = y - (shape.y + shape.radius);
          return Math.sqrt(dx * dx + dy * dy) <= shape.radius;
        case 'line':
        case 'cut-line':
          const dist = distanceToLine(x, y, shape.x, shape.y, shape.x2, shape.y2);
          return dist <= 5;
        case 'drill':
          const drillDx = x - shape.x;
          const drillDy = y - shape.y;
          return Math.sqrt(drillDx * drillDx + drillDy * drillDy) <= (shape.radius || 2.5) + 2;
        case 'polygon':
        case 'cut-curve':
          const minX = Math.min(...shape.points.map(p => p.x));
          const minY = Math.min(...shape.points.map(p => p.y));
          const maxX = Math.max(...shape.points.map(p => p.x));
          const maxY = Math.max(...shape.points.map(p => p.y));
          return x >= minX && x <= maxX && y >= minY && y <= maxY; // Bounds check for simplicity
        default:
          return false;
      }
    }

    function distanceToLine(px, py, x1, y1, x2, y2) {
      const A = px - x1;
      const B = py - y1;
      const C = x2 - x1;
      const D = y2 - y1;
      
      const dot = A * C + B * D;
      const lenSq = C * C + D * D;
      
      if (lenSq === 0) return Math.sqrt(A * A + B * B);
      
      const param = dot / lenSq;
      
      let xx, yy;
      if (param < 0) {
        xx = x1;
        yy = y1;
      } else if (param > 1) {
        xx = x2;
        yy = y2;
      } else {
        xx = x1 + param * C;
        yy = y1 + param * D;
      }
      
      const dx = px - xx;
      const dy = py - yy;
      return Math.sqrt(dx * dx + dy * dy);
    }

    function selectTool(tool) {
      currentTool = tool;
      
      document.querySelectorAll('.tool-btn[data-tool]').forEach(btn => {
        btn.classList.remove('active');
      });
      
      document.querySelector(`[data-tool="${tool}"]`).classList.add('active');
      
      canvas.style.cursor = tool === 'select' ? 'default' : 'crosshair';
      
      if (tool !== 'select') {
        selectedElement = null;
        updatePropertiesPanel();
        redrawCanvas();
      }
      
      if (tool !== 'polygon' && tool !== 'cut-curve') {
        currentPoints = [];
      }
      
      showNotification(`Outil ${getToolDisplayName(tool)} sélectionné`, 'info');
    }

    function getToolDisplayName(tool) {
      const names = {
        'select': 'Sélection',
        'move': 'Déplacement',
        'rectangle': 'Rectangle',
        'circle': 'Cercle',
        'line': 'Ligne',
        'polygon': 'Polygone',
        'cut-line': 'Découpe droite',
        'cut-curve': 'Découpe courbe',
        'drill': 'Perçage'
      };
      return names[tool] || tool;
    }

    function getShapeDisplayName(type) {
      const names = {
        'rectangle': 'Rectangle',
        'circle': 'Cercle',
        'line': 'Ligne',
        'cut-line': 'Ligne de découpe',
        'drill': 'Perçage',
        'polygon': 'Polygone',
        'cut-curve': 'Courbe de découpe'
      };
      return names[type] || type;
    }

    function generateId() {
      return Math.random().toString(36).substr(2, 9);
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${message}`;
      document.body.appendChild(notification);
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    function updatePropertiesPanel() {
      const panel = document.getElementById('properties-panel');
      if (!selectedElement) {
        panel.classList.add('hidden');
        return;
      }
      panel.classList.remove('hidden');
      document.getElementById('prop-x').value = selectedElement.x || '';
      document.getElementById('prop-y').value = selectedElement.y || '';
      document.getElementById('prop-color').value = selectedElement.color || '#1e40af';
      document.getElementById('prop-rotation').value = selectedElement.rotation || 0;
      document.getElementById('prop-thickness').value = selectedElement.thickness || 2;
      if (selectedElement.width) document.getElementById('prop-width').value = selectedElement.width || '';
      if (selectedElement.height) document.getElementById('prop-height').value = selectedElement.height || '';
      if (selectedElement.radius) {
        document.getElementById('prop-width').value = selectedElement.radius * 2 || '';
        document.getElementById('prop-height').value = selectedElement.radius * 2 || '';
      }
      // For polygon/cut-curve, perhaps hide some fields or handle differently
    }

    function updateSelectedElement() {
      if (!selectedElement) return;
      selectedElement.x = parseFloat(document.getElementById('prop-x').value) || 0;
      selectedElement.y = parseFloat(document.getElementById('prop-y').value) || 0;
      selectedElement.color = document.getElementById('prop-color').value;
      selectedElement.rotation = parseFloat(document.getElementById('prop-rotation').value) || 0;
      selectedElement.thickness = parseFloat(document.getElementById('prop-thickness').value) || 2;
      if (selectedElement.type === 'rectangle') {
        selectedElement.width = parseFloat(document.getElementById('prop-width').value) || 0;
        selectedElement.height = parseFloat(document.getElementById('prop-height').value) || 0;
      } else if (selectedElement.type === 'circle') {
        const diameter = parseFloat(document.getElementById('prop-width').value) || 0;
        selectedElement.radius = diameter / 2;
      } // Add for other types if needed
      redrawCanvas();
      updateTreeView();
    }

    function handleKeyboard(e) {
      if (e.ctrlKey) {
        if (e.key === 'z') undoAction();
        if (e.key === 'y') redoAction();
        if (e.key === 's') {
          e.preventDefault();
          saveProject();
        }
        if (e.key === '+') zoomIn();
        if (e.key === '-') zoomOut();
        if (e.key === '0') fitToScreen();
      }
      if (e.key === 'Delete') deleteSelected();
      switch (e.key.toLowerCase()) {
        case 's': selectTool('select'); break;
        case 'm': selectTool('move'); break;
        case 'r': selectTool('rectangle'); break;
        case 'c': selectTool('circle'); break;
        case 'l': selectTool('line'); break;
        case 'p': selectTool('polygon'); break;
        case 'd': selectTool('drill'); break;
      }
    }

    function saveHistory() {
      history = history.slice(0, historyStep + 1);
      history.push(JSON.stringify(shapes));
      historyStep = history.length - 1;
    }

    function undoAction() {
      if (historyStep > 0) {
        historyStep--;
        shapes = JSON.parse(history[historyStep]);
        selectedElement = null;
        redrawCanvas();
        updatePropertiesPanel();
        updateTreeView();
      }
    }

    function redoAction() {
      if (historyStep < history.length - 1) {
        historyStep++;
        shapes = JSON.parse(history[historyStep]);
        selectedElement = null;
        redrawCanvas();
        updatePropertiesPanel();
        updateTreeView();
      }
    }

    function initTreeView() {
      updateTreeView();
    }

    function updateTreeView() {
      const treeView = document.getElementById('tree-view');
      treeView.innerHTML = '';
      const sheetItem = document.createElement('div');
      sheetItem.classList.add('tree-item');
      sheetItem.innerHTML = '<i class="tree-icon fas fa-file"></i> Tôle principale';
      treeView.appendChild(sheetItem);
      shapes.forEach(shape => {
        const item = document.createElement('div');
        item.classList.add('tree-item');
        item.innerHTML = '<div class="tree-indent"></div><i class="tree-icon fas fa-shape"></i>' + getShapeDisplayName(shape.type) + ' ' + shape.id;
        if (selectedElement && selectedElement.id === shape.id) item.classList.add('selected');
        item.onclick = () => {
          selectedElement = shape;
          updatePropertiesPanel();
          redrawCanvas();
        };
        treeView.appendChild(item);
      });
    }

    function loadExampleShapes() {
      shapes = [];
      saveHistory();
      updateTreeView();
    }

    function applySheetSettings() {
      sheetConfig.width = parseFloat(document.getElementById('sheet-width').value);
      sheetConfig.height = parseFloat(document.getElementById('sheet-height').value);
      sheetConfig.thickness = parseFloat(document.getElementById('sheet-thickness').value);
      sheetConfig.material = document.getElementById('sheet-material').value;
      sheetConfig.color = document.getElementById('sheet-color').value;
      gridSize = parseFloat(document.getElementById('grid-size-input').value);
      closeModal();
      resizeCanvas();
      redrawCanvas();
      document.getElementById('grid-size').textContent = gridSize + 'mm';
      showNotification('Paramètres appliqués', 'success');
    }

    function closeModal() {
      document.getElementById('sheet-settings-modal').style.display = 'none';
    }

    function openSheetSettings() {
      document.getElementById('sheet-width').value = sheetConfig.width;
      document.getElementById('sheet-height').value = sheetConfig.height;
      document.getElementById('sheet-thickness').value = sheetConfig.thickness;
      document.getElementById('sheet-material').value = sheetConfig.material;
      document.getElementById('sheet-color').value = sheetConfig.color;
      document.getElementById('grid-size-input').value = gridSize;
      document.getElementById('sheet-settings-modal').style.display = 'flex';
    }

    function duplicateSelected() {
      if (!selectedElement) return;
      const newShape = JSON.parse(JSON.stringify(selectedElement));
      newShape.id = generateId();
      if (newShape.x !== undefined) newShape.x += 10;
      if (newShape.y !== undefined) newShape.y += 10;
      if (newShape.points) newShape.points = newShape.points.map(p => ({x: p.x + 10, y: p.y + 10}));
      if (newShape.x2 !== undefined) newShape.x2 += 10;
      if (newShape.y2 !== undefined) newShape.y2 += 10;
      shapes.push(newShape);
      selectedElement = newShape;
      saveHistory();
      updatePropertiesPanel();
      updateTreeView();
      redrawCanvas();
      showNotification('Élément dupliqué', 'success');
    }

    function deleteSelected() {
      if (!selectedElement) return;
      shapes = shapes.filter(s => s.id !== selectedElement.id);
      selectedElement = null;
      saveHistory();
      updatePropertiesPanel();
      updateTreeView();
      redrawCanvas();
      showNotification('Élément supprimé', 'success');
    }

    function zoomIn() {
      zoom = Math.min(5, zoom * 1.1);
      redrawCanvas();
    }

    function zoomOut() {
      zoom = Math.max(0.1, zoom / 1.1);
      redrawCanvas();
    }

    function fitToScreen() {
      zoom = 1;
      panX = 0;
      panY = 0;
      resizeCanvas();
    }

    function toggleTheme() {
      document.body.classList.toggle('dark');
      isDarkMode = !isDarkMode;
      const icon = document.getElementById('theme-icon');
      icon.classList.toggle('fa-moon');
      icon.classList.toggle('fa-sun');
      redrawCanvas();
    }

    function switchTab(tab) {
      document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.sidebar-tab[onclick="switchTab('${tab}')"]`).classList.add('active');
      document.getElementById('online-tab').style.display = tab === 'online' ? 'block' : 'none';
      document.getElementById('invite-tab').style.display = tab === 'invite' ? 'block' : 'none';
    }

    function sendInvite() {
      const input = document.getElementById('invite-input').value;
      if (input) {
        showNotification(`Invitation envoyée à ${input}`, 'success');
        document.getElementById('invite-input').value = '';
      }
    }

    function toggleFriendsSidebar() {
      friendsSidebarOpen = !friendsSidebarOpen;
      const sidebar = document.getElementById('friends-sidebar');
      const workspace = document.getElementById('workspace');
      const icon = document.getElementById('friends-toggle-icon');
      if (friendsSidebarOpen) {
        sidebar.classList.remove('hidden');
        workspace.classList.remove('friends-hidden');
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-left');
      } else {
        sidebar.classList.add('hidden');
        workspace.classList.add('friends-hidden');
        icon.classList.remove('fa-chevron-left');
        icon.classList.add('fa-chevron-right');
      }
    }

    function toggleExplorer() {
      explorerOpen = !explorerOpen;
      const explorer = document.getElementById('explorer');
      const workspace = document.getElementById('workspace');
      const icon = document.getElementById('explorer-toggle-icon');
      if (explorerOpen) {
        explorer.classList.remove('hidden');
        workspace.classList.remove('explorer-hidden');
        icon.classList.remove('fa-chevron-left');
        icon.classList.add('fa-chevron-right');
      } else {
        explorer.classList.add('hidden');
        workspace.classList.add('explorer-hidden');
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-left');
      }
    }

    function newSheet() {
      shapes = [];
      selectedElement = null;
      history = [];
      historyStep = 0;
      updatePropertiesPanel();
      updateTreeView();
      redrawCanvas();
      showNotification('Nouvelle tôle créée', 'success');
    }

    function saveProject() {
      // Implémentation avec Firestore possible ici
      showNotification('Projet sauvegardé', 'success');
    }

    function importProject() {
      showNotification('Importation non implémentée', 'info');
    }

    function exportProject() {
      showNotification('Exportation non implémentée', 'info');
    }
  </script>
</body>
</html>
]]>
</xaiArtifact>
