<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>SteelSketch - Mon Compte</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #1e40af;
      --primary-hover: #1d4ed8;
      --secondary: #64748b;
      --bg: #f1f5f9;
      --card-bg: #ffffff;
      --text: #0f172a;
      --text-secondary: #64748b;
      --border: #e2e8f0;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
      --success: #22c55e;
      --warning: #facc15;
      --danger: #ef4444;
      --info: #3b82f6;
      --toolbar-h: 70px;
    }

    body.dark {
      --bg: #0f172a;
      --card-bg: #1e293b;
      --text: #f8fafc;
      --text-secondary: #94a3b8;
      --border: #475569;
      --primary: #60a5fa;
      --primary-hover: #3b82f6;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s ease, color 0.3s ease;
    }

    header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: var(--toolbar-h);
      background: linear-gradient(270deg, var(--primary), #0ea5e9, var(--primary));
      background-size: 400% 400%;
      animation: headerGradient 10s ease infinite;
      color: white;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow-md);
      z-index: 1000;
    }

    @keyframes headerGradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .logo {
      font-size: 24px;
      font-weight: 700;
      letter-spacing: -0.5px;
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    .logo:hover {
      transform: scale(1.05);
    }

    .back-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
      padding: 10px 18px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      backdrop-filter: blur(10px);
      text-decoration: none;
    }

    .back-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .container {
      max-width: 900px;
      margin: calc(var(--toolbar-h) + 40px) auto 40px auto;
      padding: 0 20px;
    }

    .page-title {
      font-size: 32px;
      font-weight: 700;
      margin: 0 0 10px 0;
      animation: fadeInUp 0.5s ease;
    }

    .page-subtitle {
      font-size: 16px;
      color: var(--text-secondary);
      margin: 0 0 40px 0;
      animation: fadeInUp 0.5s ease 0.1s backwards;
    }

    .account-section {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 35px;
      margin-bottom: 25px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border);
      animation: fadeInUp 0.5s ease backwards;
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--border);
    }

    .section-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--primary), #0ea5e9);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 22px;
    }

    .section-title {
      font-size: 22px;
      font-weight: 600;
      margin: 0;
      color: var(--text);
    }

    .form-group {
      margin-bottom: 25px;
    }

    .form-label {
      display: block;
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 8px;
      color: var(--text);
    }

    .form-input {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 15px;
      background: var(--card-bg);
      color: var(--text);
      transition: all 0.3s ease;
      font-family: 'Inter', sans-serif;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
    }

    .form-input:disabled {
      background: var(--bg);
      color: var(--text-secondary);
      cursor: not-allowed;
    }

    .input-hint {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 6px;
    }

    .btn {
      padding: 14px 24px;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-family: 'Inter', sans-serif;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover:not(:disabled) {
      background: #dc2626;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .btn-secondary {
      background: var(--secondary);
      color: white;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #475569;
      transform: translateY(-2px);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    .btn-group {
      display: flex;
      gap: 12px;
      margin-top: 30px;
    }

    .info-box {
      background: var(--bg);
      border-left: 4px solid var(--info);
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 25px;
      display: flex;
      gap: 12px;
    }

    .info-box i {
      color: var(--info);
      font-size: 20px;
      margin-top: 2px;
    }

    .info-box-content {
      flex: 1;
    }

    .info-box-title {
      font-weight: 600;
      margin: 0 0 5px 0;
      font-size: 15px;
    }

    .info-box-text {
      margin: 0;
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .warning-box {
      background: rgba(239, 68, 68, 0.1);
      border-left: 4px solid var(--danger);
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 25px;
      display: flex;
      gap: 12px;
    }

    .warning-box i {
      color: var(--danger);
      font-size: 20px;
      margin-top: 2px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .stat-card {
      background: var(--bg);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 14px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 5000;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }

    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.7; }
      100% { transform: scale(1); opacity: 1; }
    }

    @media (max-width: 768px) {
      .container {
        padding: 0 15px;
      }

      .account-section {
        padding: 25px 20px;
      }

      .btn-group {
        flex-direction: column;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div id="loading-screen" class="loading-screen">
    <i class="fas fa-cube fa-3x" style="color: var(--primary); margin-bottom: 20px; animation: pulse 2s infinite;"></i>
    <h2 style="margin: 10px 0; color: var(--text);">SteelSketch</h2>
    <p style="color: var(--text-secondary); margin: 0;">Chargement...</p>
  </div>

  <header>
    <div class="logo" onclick="window.location.href='dashboard.html'">
      <i class="fas fa-cube"></i> SteelSketch
    </div>
    <a href="dashboard.html" class="back-btn">
      <i class="fas fa-arrow-left"></i> 
      Retour au dashboard
    </a>
  </header>

  <div class="container">
    <h1 class="page-title"><i class="fas fa-user-circle"></i> Mon Compte</h1>
    <p class="page-subtitle">Gérez vos informations personnelles et la sécurité de votre compte</p>

    <div class="account-section" style="animation-delay: 0.1s;">
      <div class="section-header">
        <div class="section-icon">
          <i class="fas fa-user"></i>
        </div>
        <h2 class="section-title">Informations personnelles</h2>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="account-age">-</div>
          <div class="stat-label">Jours d'activité</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="friend-code-display">------</div>
          <div class="stat-label">Code ami</div>
        </div>
      </div>

      <form id="profile-form">
        <div class="form-group">
          <label class="form-label">
            <i class="fas fa-envelope"></i> Adresse email
          </label>
          <input type="email" class="form-input" id="email" disabled>
          <p class="input-hint">L'adresse email ne peut pas être modifiée</p>
        </div>

        <div class="form-group">
          <label class="form-label">
            <i class="fas fa-user"></i> Nom d'affichage
          </label>
          <input type="text" class="form-input" id="displayName" placeholder="Votre nom d'affichage" maxlength="50">
          <p class="input-hint">Ce nom sera visible par vos amis et collaborateurs</p>
        </div>

        <div class="btn-group">
          <button type="submit" class="btn btn-primary" id="save-profile-btn">
            <i class="fas fa-save"></i> Enregistrer les modifications
          </button>
        </div>
      </form>
    </div>

    <div class="account-section" style="animation-delay: 0.2s;">
      <div class="section-header">
        <div class="section-icon">
          <i class="fas fa-lock"></i>
        </div>
        <h2 class="section-title">Sécurité du compte</h2>
      </div>

      <div class="info-box">
        <i class="fas fa-shield-alt"></i>
        <div class="info-box-content">
          <p class="info-box-title">Changement de mot de passe sécurisé</p>
          <p class="info-box-text">Pour des raisons de sécurité, un email de vérification sera envoyé à votre adresse. Vous devrez confirmer le changement avant qu'il ne soit effectif.</p>
        </div>
      </div>

      <form id="password-form">
        <div class="form-group">
          <label class="form-label">
            <i class="fas fa-key"></i> Nouveau mot de passe
          </label>
          <input type="password" class="form-input" id="newPassword" placeholder="Entrez votre nouveau mot de passe" minlength="6">
          <p class="input-hint">Minimum 6 caractères</p>
        </div>

        <div class="form-group">
          <label class="form-label">
            <i class="fas fa-key"></i> Confirmer le mot de passe
          </label>
          <input type="password" class="form-input" id="confirmPassword" placeholder="Confirmez votre nouveau mot de passe" minlength="6">
        </div>

        <div class="btn-group">
          <button type="submit" class="btn btn-primary" id="change-password-btn">
            <i class="fas fa-lock"></i> Changer le mot de passe
          </button>
        </div>
      </form>
    </div>

    <div class="account-section" style="animation-delay: 0.3s;">
      <div class="section-header">
        <div class="section-icon" style="background: linear-gradient(135deg, var(--danger), #dc2626);">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h2 class="section-title">Zone de danger</h2>
      </div>

      <div class="warning-box">
        <i class="fas fa-exclamation-triangle"></i>
        <div class="info-box-content">
          <p class="info-box-title">Suppression définitive du compte</p>
          <p class="info-box-text">Cette action est irréversible. Toutes vos données, projets, amis et groupes seront définitivement supprimés. Vous recevrez un email de confirmation avant la suppression.</p>
        </div>
      </div>

      <button class="btn btn-danger" id="delete-account-btn">
        <i class="fas fa-trash-alt"></i> Supprimer mon compte
      </button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    function hideLoadingScreen() {
      const loadingScreen = document.getElementById('loading-screen');
      if (loadingScreen) {
        loadingScreen.style.animation = 'fadeOut 0.5s forwards';
        setTimeout(() => {
          loadingScreen.style.display = 'none';
        }, 500);
      }
    }

    function showError(message) {
      const loadingScreen = document.getElementById('loading-screen');
      if (loadingScreen) {
        loadingScreen.innerHTML = `
          <i class="fas fa-exclamation-triangle fa-3x" style="color: var(--danger); margin-bottom: 20px;"></i>
          <h2 style="margin: 10px 0; color: var(--text);">Erreur</h2>
          <p style="color: var(--text-secondary); margin: 0 0 20px 0; text-align: center;">${message}</p>
          <button onclick="location.reload()" style="padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">Recharger la page</button>
        `;
      }
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 90px;
        right: 20px;
        padding: 15px 20px;
        background: ${type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#3b82f6'};
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        z-index: 3000;
        animation: slideIn 0.3s ease;
        font-weight: 500;
        max-width: 350px;
      `;
      notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${message}`;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease forwards';
        setTimeout(() => notification.remove(), 300);
      }, 4000);
    }

    function initializeApp() {
      console.log('Initializing account page...');
      
      if (typeof firebase === 'undefined') {
        console.error('Firebase not loaded!');
        showError('Firebase ne s\'est pas chargé correctement.<br>Vérifiez votre connexion internet.');
        return;
      }

      const firebaseConfig = {
        apiKey: "AIzaSyB3jjwsFcv3-gbc6ZqEyMuzfMs97SSJeE8",
        authDomain: "steelsketch-b7264.firebaseapp.com",
        projectId: "steelsketch-b7264",
        storageBucket: "steelsketch-b7264.firebasestorage.app",
        messagingSenderId: "424606073739",
        appId: "1:424606073739:web:696f400e992a50d7bee58e",
        measurementId: "G-TD79BYQ5P6"
      };

      try {
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
          console.log('Firebase initialized');
        }
        
        window.auth = firebase.auth();
        window.db = firebase.firestore();
        
        initializeAccount();
        
      } catch (error) {
        console.error('Firebase error:', error);
        showError('Erreur de configuration Firebase:<br>' + error.message);
      }
    }

    function initializeAccount() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      if (savedTheme === 'dark') {
        document.body.classList.add('dark');
      }

      auth.onAuthStateChanged((user) => {
        if (user) {
          console.log('User authenticated:', user.email);
          loadUserData(user);
        } else {
          console.log('No user - redirecting');
          window.location.href = 'index.html';
        }
      });

      const profileForm = document.getElementById('profile-form');
      if (profileForm) {
        profileForm.addEventListener('submit', (e) => {
          e.preventDefault();
          saveProfileChanges();
        });
      }

      const passwordForm = document.getElementById('password-form');
      if (passwordForm) {
        passwordForm.addEventListener('submit', (e) => {
          e.preventDefault();
          changePassword();
        });
      }

      const deleteBtn = document.getElementById('delete-account-btn');
      if (deleteBtn) {
        deleteBtn.addEventListener('click', deleteAccount);
      }
    }

    function loadUserData(user) {
      hideLoadingScreen();

      const emailInput = document.getElementById('email');
      const displayNameInput = document.getElementById('displayName');
      const friendCodeDisplay = document.getElementById('friend-code-display');

      if (emailInput) emailInput.value = user.email || '';
      if (displayNameInput) displayNameInput.value = user.displayName || '';
      if (friendCodeDisplay) friendCodeDisplay.textContent = user.uid.slice(0, 6).toUpperCase();

      db.collection('users').doc(user.uid).get()
        .then(doc => {
          if (doc.exists) {
            const data = doc.data();
            
            if (data.createdAt && data.createdAt.toDate) {
              const createdDate = data.createdAt.toDate();
              const now = new Date();
              const daysDiff = Math.floor((now - createdDate) / (1000 * 60 * 60 * 24));
              const accountAgeEl = document.getElementById('account-age');
              if (accountAgeEl) accountAgeEl.textContent = daysDiff;
            }

            if (data.displayName && displayNameInput && !displayNameInput.value) {
              displayNameInput.value = data.displayName;
            }
          }
        })
        .catch(err => {
          console.error('Error loading user data:', err);
        });
    }

    function saveProfileChanges() {
      const user = auth.currentUser;
      if (!user) {
        showNotification('Utilisateur non connecté', 'error');
        return;
      }

      const displayNameInput = document.getElementById('displayName');
      const newDisplayName = displayNameInput ? displayNameInput.value.trim() : '';

      if (!newDisplayName) {
        showNotification('Le nom d\'affichage ne peut pas être vide', 'error');
        return;
      }

      const saveBtn = document.getElementById('save-profile-btn');
      if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enregistrement...';
      }

      user.updateProfile({
        displayName: newDisplayName
      })
      .then(() => {
        return db.collection('users').doc(user.uid).set({
          displayName: newDisplayName,
          email: user.email,
          friendCode: user.uid.slice(0, 6).toUpperCase(),
          lastActive: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
      })
      .then(() => {
        showNotification('Profil mis à jour avec succès !', 'success');
      })
      .catch(error => {
        console.error('Error updating profile:', error);
        showNotification('Erreur lors de la mise à jour: ' + error.message, 'error');
      })
      .finally(() => {
        if (saveBtn) {
          saveBtn.disabled = false;
          saveBtn.innerHTML = '<i class="fas fa-save"></i> Enregistrer les modifications';
        }
      });
    }

    function changePassword() {
      const user = auth.currentUser;
      if (!user) {
        showNotification('Utilisateur non connecté', 'error');
        return;
      }

      const newPasswordInput = document.getElementById('newPassword');
      const confirmPasswordInput = document.getElementById('confirmPassword');

      const newPassword = newPasswordInput ? newPasswordInput.value : '';
      const confirmPassword = confirmPasswordInput ? confirmPasswordInput.value : '';

      if (!newPassword || !confirmPassword) {
        showNotification('Veuillez remplir tous les champs', 'error');
        return;
      }

      if (newPassword.length < 6) {
        showNotification('Le mot de passe doit contenir au moins 6 caractères', 'error');
        return;
      }

      if (newPassword !== confirmPassword) {
        showNotification('Les mots de passe ne correspondent pas', 'error');
        return;
      }

      const changeBtn = document.getElementById('change-password-btn');
      if (changeBtn) {
        changeBtn.disabled = true;
        changeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Envoi de l\'email...';
      }

      auth.sendPasswordResetEmail(user.email)
        .then(() => {
          showNotification('Un email de réinitialisation a été envoyé à ' + user.email + '. Veuillez vérifier votre boîte de réception.', 'success');
          if (newPasswordInput) newPasswordInput.value = '';
          if (confirmPasswordInput) confirmPasswordInput.value = '';
        })
        .catch(error => {
          console.error('Error sending reset email:', error);
          let errorMessage = 'Erreur lors de l\'envoi de l\'email';
          
          switch(error.code) {
            case 'auth/too-many-requests':
              errorMessage = 'Trop de tentatives. Veuillez réessayer plus tard.';
              break;
            case 'auth/user-not-found':
              errorMessage = 'Utilisateur non trouvé.';
              break;
            default:
              errorMessage = error.message;
          }
          
          showNotification(errorMessage, 'error');
        })
        .finally(() => {
          if (changeBtn) {
            changeBtn.disabled = false;
            changeBtn.innerHTML = '<i class="fas fa-lock"></i> Changer le mot de passe';
          }
        });
    }

    function deleteAccount() {
      const user = auth.currentUser;
      if (!user) {
        showNotification('Utilisateur non connecté', 'error');
        return;
      }

      const confirmText = 'Je confirme vouloir supprimer mon compte';
      const userConfirmation = prompt(
        'Cette action est IRRÉVERSIBLE et supprimera toutes vos données.\n\n' +
        'Tapez exactement "' + confirmText + '" pour confirmer la suppression:'
      );

      if (userConfirmation !== confirmText) {
        if (userConfirmation !== null) {
          showNotification('Suppression annulée - texte de confirmation incorrect', 'info');
        }
        return;
      }

      const finalConfirm = confirm(
        'DERNIÈRE CONFIRMATION\n\n' +
        'Êtes-vous absolument certain de vouloir supprimer votre compte ?\n' +
        'Cette action supprimera:\n' +
        '- Tous vos projets\n' +
        '- Tous vos amis\n' +
        '- Tous vos groupes\n' +
        '- Toutes vos données\n\n' +
        'Cette action est DÉFINITIVE et ne peut PAS être annulée.'
      );

      if (!finalConfirm) {
        showNotification('Suppression annulée', 'info');
        return;
      }

      const deleteBtn = document.getElementById('delete-account-btn');
      if (deleteBtn) {
        deleteBtn.disabled = true;
        deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Suppression en cours...';
      }

      auth.sendPasswordResetEmail(user.email)
        .then(() => {
          showNotification('Un email de confirmation a été envoyé. Veuillez confirmer la suppression via l\'email.', 'info');
          
          return new Promise((resolve) => {
            setTimeout(() => {
              const batch = db.batch();
              
              Promise.all([
                db.collection('projects').where('userId', '==', user.uid).get(),
                db.collection('friends').where('userId', '==', user.uid).get(),
                db.collection('groups').where('ownerId', '==', user.uid).get(),
                db.collection('users').doc(user.uid).get()
              ])
              .then(([projects, friends, groups, userDoc]) => {
                projects.forEach(doc => batch.delete(doc.ref));
                friends.forEach(doc => batch.delete(doc.ref));
                groups.forEach(doc => batch.delete(doc.ref));
                if (userDoc.exists) batch.delete(userDoc.ref);
                
                return batch.commit();
              })
              .then(() => {
                return user.delete();
              })
              .then(() => {
                showNotification('Compte supprimé avec succès', 'success');
                setTimeout(() => {
                  window.location.href = 'index.html';
                }, 2000);
              })
              .catch(error => {
                console.error('Error deleting account:', error);
                
                if (error.code === 'auth/requires-recent-login') {
                  showNotification('Pour des raisons de sécurité, veuillez vous reconnecter avant de supprimer votre compte.', 'error');
                  setTimeout(() => {
                    auth.signOut().then(() => {
                      window.location.href = 'index.html';
                    });
                  }, 2000);
                } else {
                  showNotification('Erreur lors de la suppression: ' + error.message, 'error');
                }
              })
              .finally(() => {
                if (deleteBtn) {
                  deleteBtn.disabled = false;
                  deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Supprimer mon compte';
                }
              });
              
              resolve();
            }, 3000);
          });
        })
        .catch(error => {
          console.error('Error sending confirmation email:', error);
          showNotification('Erreur lors de l\'envoi de l\'email de confirmation: ' + error.message, 'error');
          
          if (deleteBtn) {
            deleteBtn.disabled = false;
            deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Supprimer mon compte';
          }
        });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      setTimeout(initializeApp, 500);
    }
  </script>
</body>
</html>
