<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>SteelSketch - Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.css">
  <style>
    :root {
      --primary: #1e40af;
      --primary-hover: #1d4ed8;
      --secondary: #64748b;
      --bg: #f1f5f9;
      --card-bg: #ffffff;
      --text: #0f172a;
      --text-secondary: #64748b;
      --border: #e2e8f0;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
      --success: #22c55e;
      --warning: #facc15;
      --danger: #ef4444;
      --info: #3b82f6;
      --toolbar-h: 70px;
      --sidebar-w: 280px;
    }

    body.dark {
      --bg: #0f172a;
      --card-bg: #1e293b;
      --text: #f8fafc;
      --text-secondary: #94a3b8;
      --border: #475569;
      --primary: #60a5fa;
      --primary-hover: #3b82f6;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s ease, color 0.3s ease;
      overflow-x: hidden;
    }

    header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: var(--toolbar-h);
      background: linear-gradient(270deg, var(--primary), #0ea5e9, var(--primary));
      background-size: 400% 400%;
      animation: headerGradient 10s ease infinite;
      color: white;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow-md);
      z-index: 1000;
    }

    @keyframes headerGradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .logo {
      font-size: 24px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
      flex: 1;
      justify-content: center;
      margin-left: -200px; /* Compense le bouton de d√©connexion */
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .user-name {
      font-weight: 600;
      font-size: 16px;
    }

    .logout-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
      padding: 10px 18px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      backdrop-filter: blur(10px);
    }

    .logout-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .sidebar {
      position: fixed;
      left: 0;
      top: var(--toolbar-h);
      width: var(--sidebar-w);
      height: calc(100vh - var(--toolbar-h));
      background: var(--card-bg);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      transition: transform 0.3s ease;
      z-index: 999;
      box-shadow: var(--shadow-sm);
    }

    body.sidebar-closed .sidebar {
      transform: translateX(-100%);
    }

    .sidebar-toggle {
      position: absolute;
      top: 20px;
      right: -15px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-left: none;
      padding: 8px;
      cursor: pointer;
      border-radius: 0 8px 8px 0;
      transition: all 0.3s ease;
      color: var(--text);
      z-index: 10;
    }

    .sidebar-toggle:hover {
      background: var(--primary);
      color: white;
      transform: translateX(2px);
    }

    body.sidebar-closed .sidebar-toggle {
      transform: translateX(15px);
    }

    body.sidebar-closed .sidebar-toggle:hover {
      transform: translateX(17px);
    }

    .sidebar-header {
      padding: 30px 20px 20px 20px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .sidebar-header h2 {
      font-size: 18px;
      font-weight: 600;
      margin: 0 0 15px 0;
      color: var(--text);
    }

    .friend-code {
      background: var(--bg);
      padding: 12px 15px;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 20px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .friend-code i {
      cursor: pointer;
      color: var(--secondary);
      padding: 4px;
      border-radius: 4px;
      transition: all 0.3s ease;
    }

    .friend-code i:hover {
      color: var(--primary);
      background: rgba(30, 64, 175, 0.1);
    }

    .add-friend {
      display: flex;
      gap: 8px;
    }

    .add-friend input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      background: var(--card-bg);
      color: var(--text);
      transition: border-color 0.3s ease;
    }

    .add-friend input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .add-friend button {
      padding: 10px 15px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .add-friend button:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }

    .sidebar-content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .friend-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .friend {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg);
      border-radius: 8px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .friend:hover {
      transform: translateX(5px);
      box-shadow: var(--shadow-sm);
    }

    .status {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
      flex-shrink: 0;
    }

    .online { background: var(--success); }
    .idle { background: var(--warning); }
    .dnd { background: var(--danger); }
    .offline { background: var(--secondary); }

    .friend-name {
      font-weight: 500;
      font-size: 14px;
    }

    .no-friends {
      text-align: center;
      color: var(--text-secondary);
      font-style: italic;
      margin-top: 20px;
      font-size: 14px;
    }

    .content {
      margin-left: var(--sidebar-w);
      padding: calc(var(--toolbar-h) + 30px) 30px 30px 30px;
      transition: margin-left 0.3s ease;
      min-height: calc(100vh - var(--toolbar-h));
    }

    body.sidebar-closed .content {
      margin-left: 0;
    }

    .dashboard-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .overview-card {
      background: var(--card-bg);
      padding: 25px;
      border-radius: 12px;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
      border: 1px solid var(--border);
    }

    .overview-card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .overview-card h3 {
      font-size: 14px;
      font-weight: 600;
      margin: 0 0 10px 0;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .overview-number {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary);
    }

    .search-bar {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      align-items: center;
    }

    .search-input {
      flex: 1;
      padding: 15px 18px;
      font-size: 16px;
      border: 1px solid var(--border);
      border-radius: 10px;
      transition: all 0.3s ease;
      background: var(--card-bg);
      color: var(--text);
    }

    .search-input:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
    }

    .new-project-btn {
      position: relative;
      padding: 15px 25px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
      transition: all 0.4s cubic-bezier(0.23, 1, 0.320, 1);
      overflow: hidden;
      box-shadow: 
        0 0 0 0 rgba(102, 126, 234, 0),
        0 4px 15px rgba(102, 126, 234, 0.2);
    }

    .new-project-btn::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57);
      background-size: 400%;
      z-index: -2;
      filter: blur(5px);
      animation: glowing 20s linear infinite;
      opacity: 0;
      border-radius: 14px;
      transition: opacity 0.3s ease;
    }

    .new-project-btn::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      z-index: -1;
      border-radius: 12px;
    }

    @keyframes glowing {
      0% { background-position: 0 0; }
      50% { background-position: 400% 0; }
      100% { background-position: 0 0; }
    }

    .new-project-btn:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 
        0 0 20px 5px rgba(102, 126, 234, 0.4),
        0 8px 25px rgba(102, 126, 234, 0.3);
    }

    .new-project-btn:hover::before {
      opacity: 1;
    }

    .new-project-btn:active {
      transform: translateY(-1px) scale(1.01);
    }

    .new-project-btn i {
      margin-right: 8px;
      font-size: 16px;
    }

    .projects {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 25px;
    }

    .project-item {
      background: var(--card-bg);
      border: 1px solid var(--border);
      padding: 25px;
      border-radius: 12px;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .project-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), #0ea5e9);
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }

    .project-item:hover::before {
      transform: scaleX(1);
    }

    .project-item:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-md);
    }

    .project-name {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--text);
    }

    .project-desc {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .project-actions {
      display: flex;
      gap: 10px;
    }

    .action-btn {
      padding: 10px 16px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .action-btn.delete {
      background: var(--danger);
    }

    .action-btn:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }

    .action-btn.delete:hover {
      background: #dc2626;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
      z-index: 2000;
      animation: fadeIn 0.3s;
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background: var(--card-bg);
      padding: 35px;
      border-radius: 16px;
      box-shadow: var(--shadow-md);
      width: 450px;
      max-width: 90vw;
      animation: scaleIn 0.3s;
      position: relative;
      border: 1px solid var(--border);
    }

    .modal-close {
      position: absolute;
      top: 15px;
      right: 15px;
      cursor: pointer;
      font-size: 18px;
      color: var(--text-secondary);
      padding: 5px;
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    .modal-close:hover {
      background: var(--bg);
      color: var(--text);
    }

    .modal h2 {
      margin: 0 0 25px 0;
      font-size: 24px;
      font-weight: 600;
      color: var(--text);
    }

    .modal input {
      width: 100%;
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 16px;
      background: var(--card-bg);
      color: var(--text);
      transition: border-color 0.3s ease;
    }

    .modal input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .modal .btn {
      width: 100%;
      padding: 15px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
    }

    .modal .btn:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }

    .chart-container {
      margin-top: 40px;
      padding: 25px;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border);
    }

    .chart-container h3 {
      margin: 0 0 20px 0;
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
    }

    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 5000;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes scaleIn {
      from { transform: scale(0.95); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        transform: translateX(-100%);
      }
      
      body.sidebar-closed .sidebar {
        transform: translateX(-100%);
      }
      
      .content {
        margin-left: 0;
        padding: calc(var(--toolbar-h) + 20px) 20px 20px 20px;
      }
      
      .search-bar {
        flex-direction: column;
        gap: 10px;
      }
      
      .projects {
        grid-template-columns: 1fr;
      }
      
      .dashboard-overview {
        grid-template-columns: 1fr;
      }
      
      .user-info {
        margin-left: 0;
      }
      
      .logo {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loading-screen" class="loading-screen">
    <i class="fas fa-cube fa-3x" style="color: var(--primary); margin-bottom: 20px; animation: pulse 2s infinite;"></i>
    <h2 style="margin: 10px 0; color: var(--text);">SteelSketch</h2>
    <p style="color: var(--text-secondary); margin: 0;">Chargement...</p>
  </div>

  <!-- Header -->
  <header>
    <div class="logo">
      <i class="fas fa-cube"></i> SteelSketch
    </div>
    <div class="user-info">
      <div class="user-avatar"><i class="fas fa-user"></i></div>
      <span class="user-name" id="user-name">Chargement...</span>
    </div>
    <button class="logout-btn" onclick="logout()">
      <i class="fas fa-sign-out-alt"></i> 
      D√©connexion
    </button>
  </header>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <button class="sidebar-toggle" onclick="toggleSidebar()">
      <i class="fas fa-chevron-left"></i>
    </button>
    
    <div class="sidebar-header">
      <h2><i class="fas fa-users"></i> Amis</h2>
      <div class="friend-code">
        Code ami : <strong id="friend-code">Chargement...</strong> 
        <i class="fas fa-copy" onclick="copyFriendCode()" title="Copier le code"></i>
      </div>
      <div class="add-friend">
        <input type="text" id="add-friend-input" placeholder="Code ami..." maxlength="6">
        <button onclick="addFriend()"><i class="fas fa-plus"></i></button>
      </div>
    </div>
    
    <div class="sidebar-content">
      <div class="friend-list" id="friend-list">
        <!-- Amis list√©s ici -->
      </div>
    </div>
  </div>

  <!-- Contenu principal -->
  <div class="content">
    <h1 style="animation: fadeInUp 0.5s; margin: 0 0 30px 0; font-size: 32px; font-weight: 700;">
      <i class="fas fa-folder-open"></i> Mes Projets
    </h1>
    
    <div class="search-bar">
      <input class="search-input" type="text" placeholder="üîç Rechercher un projet..." onkeyup="searchProjects(this.value)">
      <button class="new-project-btn" onclick="openCreateModal()">
        <i class="fas fa-plus"></i> Nouveau projet
      </button>
    </div>

    <div class="dashboard-overview">
      <div class="overview-card">
        <h3>Projets totaux</h3>
        <div class="overview-number" id="total-projects">0</div>
      </div>
      <div class="overview-card">
        <h3>Projets partag√©s</h3>
        <div class="overview-number" id="shared-projects">0</div>
      </div>
      <div class="overview-card">
        <h3>Dernier projet</h3>
        <div class="overview-number" id="last-project" style="font-size: 16px; font-weight: 600;">Aucun</div>
      </div>
    </div>

    <div class="chart-container">
      <h3><i class="fas fa-chart-line"></i> Activit√© r√©cente</h3>
      <canvas id="activityChart"></canvas>
    </div>

    <div class="projects" id="projects-list">
      <!-- Projets -->
    </div>
  </div>

  <!-- Modal Cr√©er Projet -->
  <div id="createModal" class="modal">
    <div class="modal-content">
      <i class="fas fa-times modal-close" onclick="closeModal()"></i>
      <h2><i class="fas fa-plus-circle"></i> Cr√©er un nouveau projet</h2>
      <input id="projectName" type="text" placeholder="Nom du projet" maxlength="50">
      <input id="projectDesc" type="text" placeholder="Description (optionnel)" maxlength="200">
      <button class="btn" onclick="createNewProject()">
        <i class="fas fa-rocket"></i> Cr√©er le projet
      </button>
    </div>
  </div>

  <!-- Firebase + librairies -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

  <script>
    // Masquer l'√©cran de chargement apr√®s initialisation
    function hideLoadingScreen() {
      const loadingScreen = document.getElementById('loading-screen');
      if (loadingScreen) {
        loadingScreen.style.animation = 'fadeOut 0.5s forwards';
        setTimeout(() => {
          loadingScreen.style.display = 'none';
        }, 500);
      }
    }

    // Afficher message d'erreur
    function showError(message) {
      const loadingScreen = document.getElementById('loading-screen');
      if (loadingScreen) {
        loadingScreen.innerHTML = `
          <i class="fas fa-exclamation-triangle fa-3x" style="color: var(--danger); margin-bottom: 20px;"></i>
          <h2 style="margin: 10px 0; color: var(--text);">Erreur</h2>
          <p style="color: var(--text-secondary); margin: 0 0 20px 0; text-align: center;">${message}</p>
          <button onclick="location.reload()" style="padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">Recharger la page</button>
        `;
      }
    }

    // Attendre que Firebase soit charg√©
    function initializeApp() {
      console.log('Initializing app...');
      
      // V√©rifier si Firebase est charg√©
      if (typeof firebase === 'undefined') {
        console.error('Firebase n\'est pas charg√© !');
        showError('Firebase ne s\'est pas charg√© correctement.<br>V√©rifiez votre connexion internet.');
        return;
      }

      console.log('Firebase detected, initializing...');

      // Configuration Firebase - REMPLACE PAR TES VRAIES CL√âS !
      const firebaseConfig = {
        apiKey: "AIzaSyBXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX", // Ta vraie API Key
        authDomain: "steelsketch-xxxxx.firebaseapp.com",             // Ton domaine
        projectId: "steelsketch-xxxxx",                             // Ton project ID
        storageBucket: "steelsketch-xxxxx.appspot.com",             // Ton storage bucket
        messagingSenderId: "123456789012",                          // Ton sender ID  
        appId: "1:123456789012:web:abcdefghijklmnopqrstuvwx"        // Ton app ID
      };

      try {
        // Initialisation Firebase
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
          console.log('Firebase initialis√© avec succ√®s');
        }
        
        window.auth = firebase.auth();
        window.db = firebase.firestore();
        
        // Maintenant on peut initialiser l'app
        initializeDashboard();
        
      } catch (error) {
        console.error('Erreur Firebase:', error);
        showError('Erreur de configuration Firebase:<br>' + error.message + '<br><br>V√©rifiez votre configuration.');
      }
    }

    function initializeDashboard() {
      console.log('Initializing dashboard...');
      
      let authInitialized = false;
      let authTimeout;

      // Fonction pour v√©rifier l'authentification
      function checkAuth() {
        console.log('Checking auth...');
        
        const currentUser = auth.currentUser;
        if (currentUser) {
          console.log('User found immediately:', currentUser.email);
          initializeUserData(currentUser);
          return;
        }

        console.log('No immediate user, waiting...');
        
        // Timeout de s√©curit√©
        authTimeout = setTimeout(() => {
          console.log('Auth timeout - redirecting to login');
          window.location.href = 'index.html';
        }, 3000);
      }

      function initializeUserData(user) {
        console.log('Initializing user data for:', user.email);
        
        if (authTimeout) {
          clearTimeout(authTimeout);
          authTimeout = null;
        }
        
        authInitialized = true;
        
        // Masquer l'√©cran de chargement
        hideLoadingScreen();
        
        // Afficher le nom d'utilisateur
        const nameEl = document.getElementById('user-name');
        if (nameEl) {
          const displayName = user.displayName || 
                             user.email?.split('@')[0] || 
                             'Utilisateur';
          nameEl.innerText = displayName;
          console.log('Display name set to:', displayName);
        }
        
        // Initialiser les donn√©es utilisateur
        generateFriendCode(user.uid);
        loadFriends(user.uid);
        loadProjects(user.uid);
        loadActivityChart(user.uid);
      }

      // Gestion de l'authentification
      auth.onAuthStateChanged((user) => {
        console.log('Auth state changed:', user ? `${user.email} (${user.uid.slice(0,8)}...)` : 'null');
        
        if (user) {
          initializeUserData(user);
        } else if (authInitialized) {
          console.log('User signed out - redirecting');
          window.location.href = 'index.html';
        } else {
          console.log('No user on initial load - checking auth in 1 second');
          setTimeout(checkAuth, 1000);
        }
      });

      // D√©clarer toutes les fonctions globales
      window.logout = function() {
        if (confirm('√ätes-vous s√ªr de vouloir vous d√©connecter ?')) {
          console.log('Logging out...');
          auth.signOut().then(() => {
            console.log('User signed out successfully');
            window.location.href = 'index.html';
          }).catch(err => {
            console.error('Erreur logout:', err);
            alert('Erreur lors de la d√©connexion: ' + err.message);
          });
        }
      };

      window.toggleSidebar = function() {
        const isClosed = document.body.classList.contains('sidebar-closed');
        document.body.classList.toggle('sidebar-closed', !isClosed);
        
        const toggleIcon = document.querySelector('.sidebar-toggle i');
        if (toggleIcon) {
          toggleIcon.className = isClosed ? 'fas fa-chevron-left' : 'fas fa-chevron-right';
        }
      };

      window.generateFriendCode = function(uid) {
        const code = uid.slice(0, 6).toUpperCase();
        const fcEl = document.getElementById('friend-code');
        if (fcEl) fcEl.innerText = code;
      };

      window.copyFriendCode = function() {
        const code = document.getElementById('friend-code').innerText;
        if (code && code !== 'Chargement...') {
          navigator.clipboard.writeText(code).then(() => {
            const copyIcon = document.querySelector('.friend-code i');
            if (copyIcon) {
              const originalClass = copyIcon.className;
              const originalColor = copyIcon.style.color;
              copyIcon.className = 'fas fa-check';
              copyIcon.style.color = 'var(--success)';
              setTimeout(() => {
                copyIcon.className = originalClass;
                copyIcon.style.color = originalColor;
              }, 2000);
            }
            showNotification('Code copi√© dans le presse-papiers !', 'success');
          }).catch(() => {
            showNotification('Impossible de copier le code', 'error');
          });
        }
      };

      window.addFriend = function() {
        const input = document.getElementById('add-friend-input');
        if (!input) return;
        
        const code = input.value.toUpperCase().trim();
        if (!code) {
          showNotification('Veuillez entrer un code ami', 'error');
          return;
        }
        
        if (code.length !== 6) {
          showNotification('Le code ami doit contenir 6 caract√®res', 'error');
          return;
        }
        
        const user = auth.currentUser;
        if (!user) return;

        const ownCode = user.uid.slice(0, 6).toUpperCase();
        if (code === ownCode) {
          showNotification("Vous ne pouvez pas vous ajouter vous-m√™me !", 'error');
          return;
        }

        // V√©rifier si d√©j√† ajout√©
        db.collection('friends')
          .where('userId', '==', user.uid)
          .where('friendCode', '==', code)
          .get()
          .then(snapshot => {
            if (!snapshot.empty) {
              showNotification('Cet ami est d√©j√† dans votre liste !', 'error');
              return;
            }
            
            return db.collection('friends').add({
              userId: user.uid,
              friendCode: code,
              status: 'pending',
              addedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          })
          .then(() => {
            input.value = '';
            loadFriends(user.uid);
            showNotification('Ami ajout√© avec succ√®s !', 'success');
          })
          .catch(err => {
            console.error('Erreur addFriend:', err);
            showNotification('Erreur lors de l\'ajout : ' + err.message, 'error');
          });
      };

      window.loadFriends = function(userId) {
        const container = document.getElementById('friend-list');
        if (!container) return;
        
        container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Chargement...</div>';
        
        db.collection('friends')
          .where('userId', '==', userId)
          .orderBy('addedAt', 'desc')
          .get()
          .then(snapshot => {
            container.innerHTML = '';
            if (snapshot.empty) {
              container.innerHTML = '<div class="no-friends"><i class="fas fa-user-friends"></i><br>Aucun ami ajout√© pour le moment.<br><small>Ajoutez des amis avec leur code !</small></div>';
              return;
            }
            
            snapshot.forEach(doc => {
              const data = doc.data();
              const div = document.createElement('div');
              div.className = 'friend';
              
              const statuses = ['online', 'offline', 'idle', 'dnd'];
              const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
              
              div.innerHTML = `
                <span class="status ${randomStatus}"></span>
                <span class="friend-name">${data.friendCode}</span>
                <i class="fas fa-times" style="margin-left: auto; cursor: pointer; color: var(--danger); opacity: 0.7; padding: 5px;" onclick="removeFriend('${doc.id}')" title="Supprimer cet ami"></i>
              `;
              container.appendChild(div);
            });
          })
          .catch(err => {
            console.error('Erreur loadFriends:', err);
            container.innerHTML = '<div class="no-friends" style="color: var(--danger);"><i class="fas fa-exclamation-triangle"></i><br>Erreur de chargement</div>';
          });
      };

      window.removeFriend = function(friendId) {
        if (confirm('√ätes-vous s√ªr de vouloir supprimer cet ami ?')) {
          db.collection('friends').doc(friendId).delete()
            .then(() => {
              const user = auth.currentUser;
              if (user) loadFriends(user.uid);
              showNotification('Ami supprim√©', 'success');
            })
            .catch(err => {
              console.error('Erreur removeFriend:', err);
              showNotification('Erreur lors de la suppression', 'error');
            });
        }
      };

      window.openCreateModal = function() {
        const modal = document.getElementById('createModal');
        if (modal) {
          modal.style.display = 'flex';
          const nameInput = document.getElementById('projectName');
          if (nameInput) {
            setTimeout(() => nameInput.focus(), 100);
          }
        }
      };

      window.closeModal = function() {
        const modal = document.getElementById('createModal');
        if (modal) {
          modal.style.display = 'none';
          const nameInput = document.getElementById('projectName');
          const descInput = document.getElementById('projectDesc');
          if (nameInput) nameInput.value = '';
          if (descInput) descInput.value = '';
        }
      };

      window.createNewProject = function() {
        const nameInput = document.getElementById('projectName');
        const descInput = document.getElementById('projectDesc');
        if (!nameInput) return;
        
        const name = nameInput.value.trim();
        const desc = descInput ? descInput.value.trim() : '';

        if (!name) {
          showNotification('Le nom du projet est requis', 'error');
          nameInput.focus();
          return;
        }

        const user = auth.currentUser;
        if (!user) {
          showNotification('Utilisateur non connect√©', 'error');
          return;
        }

        const createBtn = document.querySelector('.modal .btn');
        if (createBtn) {
          createBtn.disabled = true;
          createBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cr√©ation...';
        }

        db.collection('projects').add({
          name: name,
          desc: desc || 'Aucune description',
          userId: user.uid,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          lastModified: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
          closeModal();
          loadProjects(user.uid);
          showNotification('Projet cr√©√© avec succ√®s !', 'success');
        }).catch(err => {
          console.error('Erreur createProject:', err);
          showNotification('Erreur lors de la cr√©ation : ' + err.message, 'error');
        }).finally(() => {
          if (createBtn) {
            createBtn.disabled = false;
            createBtn.innerHTML = '<i class="fas fa-rocket"></i> Cr√©er le projet';
          }
        });
      };

      window.loadProjects = function(userId) {
        const container = document.getElementById('projects-list');
        if (!container) return;
        
        const totalProjects = document.getElementById('total-projects');
        const lastProject = document.getElementById('last-project');
        const sharedProjects = document.getElementById('shared-projects');
        
        container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 40px;"><i class="fas fa-spinner fa-spin fa-2x"></i><br><br>Chargement des projets...</div>';
        
        db.collection('projects')
          .where('userId', '==', userId)
          .orderBy('createdAt', 'desc')
          .get()
          .then(snapshot => {
            // Mise √† jour des statistiques
            if (totalProjects) totalProjects.innerText = snapshot.size;
            if (sharedProjects) sharedProjects.innerText = '0'; // TODO: logique pour projets partag√©s
            
            if (snapshot.size > 0 && lastProject) {
              const latestProject = snapshot.docs[0].data();
              lastProject.innerText = latestProject.name;
              lastProject.style.fontSize = '16px';
            } else if (lastProject) {
              lastProject.innerText = 'Aucun';
              lastProject.style.fontSize = '16px';
            }
            
            container.innerHTML = '';
            
            if (snapshot.empty) {
              container.innerHTML = `
                <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                  <i class="fas fa-folder-open fa-4x" style="margin-bottom: 20px; opacity: 0.5;"></i>
                  <h3 style="margin: 20px 0 10px 0; font-weight: 600;">Aucun projet pour le moment</h3>
                  <p style="margin: 0; font-size: 16px;">Cr√©ez votre premier projet pour commencer !</p>
                </div>
              `;
              return;
            }
            
            snapshot.forEach((doc, index) => {
              const data = doc.data();
              const div = document.createElement('div');
              div.className = 'project-item';
              div.style.animationDelay = `${index * 0.1}s`;
              div.style.animation = 'fadeInUp 0.5s ease forwards';
              
              // Format de la date
              let dateStr = 'Date inconnue';
              if (data.createdAt && data.createdAt.toDate) {
                const date = data.createdAt.toDate();
                dateStr = date.toLocaleDateString('fr-FR', {
                  day: 'numeric',
                  month: 'short',
                  year: 'numeric'
                });
              }
              
              div.innerHTML = `
                <div class="project-name">${data.name}</div>
                <div class="project-desc">${data.desc || 'Aucune description'}</div>
                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 15px;">
                  <i class="fas fa-calendar-alt"></i> Cr√©√© le ${dateStr}
                </div>
                <div class="project-actions">
                  <button class="action-btn" onclick="openProject('${doc.id}')">
                    <i class="fas fa-external-link-alt"></i> Ouvrir
                  </button>
                  <button class="action-btn delete" onclick="deleteProject('${doc.id}')">
                    <i class="fas fa-trash-alt"></i> Supprimer
                  </button>
                </div>
              `;
              container.appendChild(div);
            });
          })
          .catch(err => {
            console.error('Erreur loadProjects:', err);
            container.innerHTML = '<div style="text-align: center; color: var(--danger); padding: 40px;"><i class="fas fa-exclamation-triangle fa-2x"></i><br><br>Erreur de chargement des projets</div>';
          });
      };

      window.searchProjects = function(query) {
        const items = document.querySelectorAll('.project-item');
        const searchQuery = query.toLowerCase().trim();
        
        items.forEach(item => {
          const nameEl = item.querySelector('.project-name');
          const descEl = item.querySelector('.project-desc');
          
          if (!nameEl) return;
          
          const name = nameEl.innerText.toLowerCase();
          const desc = descEl ? descEl.innerText.toLowerCase() : '';
          
          const matches = name.includes(searchQuery) || desc.includes(searchQuery);
          
          item.style.display = matches || searchQuery === '' ? 'block' : 'none';
          
          if (matches && searchQuery !== '') {
            item.style.animation = 'fadeInUp 0.3s ease';
          }
        });
        
        // Afficher un message si aucun r√©sultat
        const container = document.getElementById('projects-list');
        const visibleItems = Array.from(items).filter(item => item.style.display !== 'none');
        
        if (visibleItems.length === 0 && searchQuery !== '' && items.length > 0) {
          const noResults = document.createElement('div');
          noResults.id = 'no-results';
          noResults.style.cssText = 'text-align: center; padding: 40px; color: var(--text-secondary);';
          noResults.innerHTML = `
            <i class="fas fa-search fa-2x" style="margin-bottom: 15px; opacity: 0.5;"></i>
            <h3>Aucun projet trouv√©</h3>
            <p>Essayez avec d'autres mots-cl√©s</p>
          `;
          container.appendChild(noResults);
        } else {
          const existingNoResults = document.getElementById('no-results');
          if (existingNoResults) existingNoResults.remove();
        }
      };

      window.openProject = function(id) {
        showNotification('Ouverture du projet...', 'info');
        setTimeout(() => {
          alert(`Projet ${id} ouvert (fonctionnalit√© √† impl√©menter)`);
        }, 1000);
      };

      window.deleteProject = function(id) {
        if (confirm('√ätes-vous s√ªr de vouloir supprimer ce projet ? Cette action est irr√©versible.')) {
          db.collection('projects').doc(id).delete()
            .then(() => {
              const user = auth.currentUser;
              if (user) {
                loadProjects(user.uid);
                showNotification('Projet supprim√©', 'success');
              }
            })
            .catch(err => {
              console.error('Erreur deleteProject:', err);
              showNotification('Erreur lors de la suppression', 'error');
            });
        }
      };

      window.loadActivityChart = function(userId) {
        const ctxEl = document.getElementById('activityChart');
        if (!ctxEl) return;
        
        const ctx = ctxEl.getContext('2d');
        
        // Donn√©es d'exemple - √† remplacer par de vraies donn√©es de Firebase
        const months = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin'];
        const projectsData = [2, 4, 1, 6, 3, 5];
        
        window.activityChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: months,
            datasets: [{
              label: 'Projets cr√©√©s',
              data: projectsData,
              borderColor: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim(),
              backgroundColor: 'rgba(30, 64, 175, 0.1)',
              borderWidth: 3,
              tension: 0.4,
              fill: true,
              pointBackgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim(),
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointRadius: 6,
              pointHoverRadius: 8
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: {
                  usePointStyle: true,
                  padding: 20,
                  font: {
                    size: 14,
                    weight: 500
                  }
                }
              }
            },
            scales: {
              x: {
                grid: {
                  display: false
                },
                ticks: {
                  font: {
                    size: 12,
                    weight: 500
                  }
                }
              },
              y: {
                beginAtZero: true,
                grid: {
                  color: 'rgba(0,0,0,0.05)'
                },
                ticks: {
                  stepSize: 1,
                  font: {
                    size: 12
                  }
                }
              }
            },
            animation: {
              duration: 2000,
              easing: 'easeInOutQuart'
            },
            interaction: {
              intersect: false,
              mode: 'index'
            }
          }
        });
      };

      window.showNotification = function(message, type = 'info') {
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 90px;
          right: 20px;
          padding: 15px 20px;
          background: ${type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--danger)' : 'var(--info)'};
          color: white;
          border-radius: 8px;
          box-shadow: var(--shadow-md);
          z-index: 3000;
          animation: slideIn 0.3s ease;
          font-weight: 500;
          max-width: 300px;
        `;
        notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info'}"></i> ${message}`;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.style.animation = 'slideOut 0.3s ease forwards';
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      };

      // Gestion des √©v√©nements clavier
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeModal();
        }
      });

      // √âv√©nements Enter pour les inputs
      document.addEventListener('DOMContentLoaded', () => {
        const addFriendInput = document.getElementById('add-friend-input');
        if (addFriendInput) {
          addFriendInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              addFriend();
            }
          });
        }
        
        const projectNameInput = document.getElementById('projectName');
        if (projectNameInput) {
          projectNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              createNewProject();
            }
          });
        }
        
        const searchInput = document.querySelector('.search-input');
        if (searchInput) {
          searchInput.addEventListener('input', (e) => {
            searchProjects(e.target.value);
          });
        }
      });

      console.log('Dashboard initialized successfully');
    }

    // Style pour le pulse de l'ic√¥ne de chargement
    const pulseStyle = document.createElement('style');
    pulseStyle.textContent = `
      @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.7; }
        100% { transform: scale(1); opacity: 1; }
      }
      
      @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
      }
    `;
    document.head.appendChild(pulseStyle);

    // Attendre que tout soit charg√© avant d'initialiser
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      // Si le DOM est d√©j√† charg√©, attendre un peu pour les scripts Firebase
      setTimeout(initializeApp, 500);
    }
  </script>

</body>
</html>
